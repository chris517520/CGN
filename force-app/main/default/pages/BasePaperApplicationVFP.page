<apex:page docType="html-5.0" sidebar="false" showHeader="false" title="Paper Application" controller="eSalePaperApplicationCtrl" action="{!getFileStoreRecord}">
    <head>
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width"/>
        <style type="text/css">
            .loading-div {
                top:0px;
                left:0px;
            }

         /*   @media (min-width: 768px) {
                .header-bar {
                    background-image: url({!URLFOR($Resource.KV_Get_Quote)});
                    background-size: cover;
                    background-position-y: 37%;
                }
            }
            @media (max-width: 767px) {
                .header-bar {
                    background-image: url({!URLFOR($Resource.KV_Get_Quote_Mobile)});
                    background-size: cover;
                    background-position-y: 48%;
                }
            }*/
            .bs .cigna-btn-desktop {
                width: 30%;
                text-transform: uppercase;
                /* Rancho_HKITSFDC264_20250903 - replace "Gotham SSm A", "Gotham SSm B" */
                font-family: "ValueSansRegular", "Microsoft Jhenghei", "LiHei Pro", "Heiti TC", Arial, Helvetica, sans-serif;
                font-style: normal;
                font-weight: 500;
            }
            .content-choice{
                font-size:14px !important;
                padding-top:20px !important;
                padding-bottom:20px !important;
                border-bottom:1px solid #f2f2f2 !important;
            }
            
            <!--additional inline css-->
            <!--tooltips-->
            .tooltip {
                position: relative;
                display: inline-block;
            }
            .tooltip .tooltiptext {
                visibility: hidden;
                width: 120px;
                background-color: black;
                color: #fff;
                text-align: center;
                border-radius: 6px;
                padding: 5px 0;
            }
            .tooltip:hover .tooltiptext {
                visibility: visible;
            }
            .tooltip-inner {
                /* Change the tooltip width here */
                max-width: 250px !important;
                /* If max-width does not work, try using width instead */
                width: 250px; 
                min-width: 100px;
            }
        </style>       
        <script type="text/javascript">
            var __sfdcSessionId = '{!GETSESSIONID()}';
            var filesToUpload = '';  
            var uploadedFile = 0;
        </script>
        <script src="/soap/ajax/32.0/connection.js" type="text/javascript"></script>
        <script type="text/javascript">

            var Cigna = Cigna || {};
            Cigna.PaperApp = function(){

                function showLoadingIcon(id){
                    $('#' + id).show();
                }
        
                function hideLoadingIcon(id){
                    $('#' + id).hide();
                }

                function uploadFile(parentId, attType){
                        
                    showLoadingIcon('snd-loading-phurl');

                    $('#errNoFile').hide();
                    
                    //Add by Manuel on 20180927 to support multiple files select and upload function
                    var arrFiles = new Array();

                    $("#"+attType).each(function(){
                      //filesToUpload=$(this)[0].files[0]; // Comment by Manuel on 20180927 that legacy single file select upload every time
                      for(var j=0; j<$(this)[0].files.length; j++){
                          arrFiles[j] = $(this)[0].files[j];
                      }
                    });
                    for(var k=0; k<arrFiles.length; k++){
                        filesToUpload = arrFiles[k];
                    //CR-56_Link_20220214
                        if($('[att-type="User_PaperAPP"]').length>=10){
                            $('#errOnlyAllowOneFile').show();
                            hideLoadingIcon('snd-loading-phurl');
                            return;
                        }else{
                            $('#errOnlyAllowOneFile').hide();
                        }
                        
                        var reader = new FileReader();
                
                        // Keep a reference to the File in the FileReader so it can be accessed in callbacks
                        reader.file = filesToUpload;
                        
                        if(typeof(filesToUpload)  === "undefined"){
                            alert('please select file.');
                            
                        }else{
                            reader.onload = function(e)
                            {
                                // minghua - 20220523 - file virus scan
                                // var maxFileSize = 26214400;//7340032;
                                var maxFileSize = 10485760;
                                var passFileSize;
                                var passFileType;
                                
                                if(this.file.size>maxFileSize){
                                    $("#errFileSize").show();
                                    passFileType = false;
                                }else{
                                    passFileSize = 'true';
                                    $("#errFileSize").hide();
                                }
                            
                                if(this.file.type!='application/pdf' && this.file.type!='image/png' && this.file.type!='image/jpeg' && this.file.type!='image/tiff' && this.file.type!='image/gif' ){
                                    $("#errFileType").show();
                                    hideLoadingIcon('snd-loading-phurl');
                                }else{
                                    passFileType  = 'true';
                                    $("#errFileType").hide();
                                }
                                
                                if(passFileType=='true' && passFileSize=='true' && parentId && parentId!=undefined){
                                
                                    var att = new sforce.SObject("Attachment");
                                    var num = Math.random()*9999;
                                    num = parseInt(num, 10);
                                    
                                    $('input[type="hidden"][id$="randomNum"]').val(num);
                                    console.log('randomNum ' + num);
                                                    
                                    var binary = "";
                                    var bytes = new Uint8Array(e.target.result);
                                    var length = bytes.byteLength;
                    
                                    for (var i = 0; i < length; i++)
                                    {
                                        binary += String.fromCharCode(bytes[i]);
                                    }
                    
                                    var attachment_object = {
                                        parentId: parentId,
                                        Body: window.btoa(binary), 
                                        Name: attType+'_'+this.file.name, 
                                        ContentType: this.file.type 
                                    };
                    
                                    $.ajax({
                                        url: '{!$Site.BaseUrl}/services/data/v38.0/sobjects/Attachment',
                                        data: JSON.stringify(attachment_object),
                                        type: 'POST',
                                        processData: false,
                                        contentType: false,
                                        headers: {'Authorization': 'Bearer '+__sfdcSessionId, 'Content-Type': 'application/json'},
                                        xhr: function(){
                                            var xhr = new window.XMLHttpRequest();
                                            //Upload progress
                                            xhr.upload.addEventListener("progress", function(evt){
                                                if (evt.lengthComputable) {
                                                    var percentComplete = evt.loaded / evt.total;
                                                    //Do something with upload progress
                                                    console.log("Percentage:"+percentComplete);
                                                }
                                            }, false);
                                            return xhr;
                                        },
                                        success: function(response) {
                                            hideLoadingIcon('snd-loading-phurl');
                                            refreshAttlist();
                                            console.log("uploaded succesfully");
                                            $("html, body").animate({ scrollTop: $(document).height() }, "slow");
                                        },
        
                                        error: function(xhr, status, error) {
                                            var errorMessage = xhr.status + ': ' + xhr.statusText;
                                            console.log('ERROR:'+ errorMessage);
                                            hideLoadingIcon('snd-loading-phurl');
                                        }
                                    });
                                }else{
                                    hideLoadingIcon('snd-loading-phurl');
                                }
                            };
                            
                            if(filesToUpload!='' || filesToUpload!='1'){
                                reader.readAsArrayBuffer(filesToUpload);
                                $("#errNoFile").hide();
                            }else{
                                //finishSubmission();
                                $("#errNoFile").show();
                            }
                        }
                    }
                } 

                function submitDoc(){
                    console.log('validation for upload doc');
                    //CR-56_Link_20220214
                    console.log('validation for upload doc');
                    if($('[att-type="User_PaperAPP"]').length<1){
                        $('#errUpdateAllFile').show();
                        return;
                    }
                    if($('[att-type="User_PaperAPP"]').length>10){
                        $('#errOnlyAllowOneFile').show();
                        return;
                    }
                    showLoadingIcon('snd-loading-phurl');
                    submit();

                }

                function goHome() {
                    console.log('go home');
                    var sitePrefix = "{!$Site.Prefix}";
                    var url = "";

                    // Rancho_BPE57_01_20210426
                    // if (sitePrefix == "/broker") {
                    var userAgent = window.navigator.userAgent.toLowerCase();
                    var sf1withoutBrowser = /salesforce1/i.test( userAgent );
                    var tempSiteName = "{!$Setup.Portal_Settings__c.Broker_Portal_Lightning_Site_Name__c}";
                    var siteName = "{!$Site.name}";
                    if(Cigna.Util.isBrokerPortal()){
                        // url = sitePrefix + "/apex/BrkBrokerLandingVFP";
                        if(siteName==tempSiteName){
                            url = sitePrefix + "/s/";
                        }else{
                            url = sitePrefix + "/apex/BrkBrokerLandingVFP";
                        }
                    } else if (sitePrefix == "/customer") {
                        url = sitePrefix + "/apex/CustomerLandingPage";
                    } else {
                        var currentUrl = window.location.href.substring(window.location.href.lastIndexOf('/'));
                        if (currentUrl.toLowerCase().indexOf('/cus') == 0) {
                            url = "/apex/CustomerLandingPage"; 
                        } else if (currentUrl.toLowerCase().indexOf('/brk') == 0) {
                            // Rancho_BPE57_01_20210426
                            // url = "/apex/BrkBrokerLandingVFP";
                            if(siteName==tempSiteName){
                                url = sitePrefix + "/s/";
                            }else{
                                url = sitePrefix + "/apex/BrkBrokerLandingVFP";
                            }
                        } else {
                            url = "/apex/CustomerLandingPage"; 
                        } 
                    }
                    console.log('url: '+url+' cigna: '+Cigna.Util.isSalesforce1());
                    if (Cigna.Util.isSalesforce1()) {
                        // Rancho_BPE57_01_20210426
                        if(siteName==tempSiteName){
                            window.parent.location.href = url;
                        }else{
                            sforce.one.navigateToURL(url, true);
                        }
                    } else {
                        window.parent.location.href = url;
                    }
                }

                function goBack(){
                    var fromPage = $('input[type="hidden"][id$="fromPage"]').val();
                    if(fromPage == 'Quote'){
                        Cigna.Util.navigateToVFP("GetQuoteVFP?tid={!JSINHTMLENCODE(paratid)}", null, null, true);
                    }else{
                        Cigna.Util.navigateToVFP("GetProtectedVFP?pc={!JSINHTMLENCODE(paraProductCode)}", null, null, true);
                    }
                    
                }

                return {
                    showLoadingIcon : showLoadingIcon,
                    hideLoadingIcon : hideLoadingIcon,
                    uploadFile : uploadFile,
                    submitDoc : submitDoc,
                    goHome : goHome,
                    goBack : goBack
                }
            }(); 
            
            $(document).ready(function(){
                //CR-56_Link_20220214
                $('[data-toggle="tooltip"]').tooltip();
            });
        </script> 
    </head>
    <apex:define name="additionalLibraries">
         <!--additional css, bootstrap, jquery,js libraries-->
         <apex:stylesheet value="{!URLFOR($Resource.Cigna_HK_Icons, 'Cigna-HK-Icons.css')}"/>
    </apex:define>
    
    <apex:form id="papaerapplication">
        <apex:actionFunction name="refreshAttlist" rerender="uploadatt" status="loader-icon"/>
        <apex:actionFunction name="removeAttachment" action="{!removeAtt}" rerender="uploadatt">
            <apex:param name="id" value="" assignTo="{!removeAttId}" />
        </apex:actionFunction> 
        <apex:actionFunction name="sendNotification" action="{!sendNotification}" rerender="papaerapplication,buttonApp"/>
         <apex:actionFunction name="submit" action="{!submit}" oncomplete="sendNotification()" rerender="papaerapplication,buttonApp"/>
        <apex:inputHidden id="randomNum" value="{!randomNum}"/>
        <apex:inputHidden id="fromPage" value="{!parafromPage}"/>

        <apex:outputPanel id="errorMessage">
            <div class="bs row">
                <apex:pagemessages ></apex:pagemessages>
            </div>
        </apex:outputPanel>
            
        <apex:outputPanel rendered="{!!resultPart}"> 
            <div id="product-back">
                <div class="bs col-xs-12">
                    <p><a id="product-back-btn" href="#" class="bs cigna-fg-orange-medium" onclick="Cigna.PaperApp.goBack();"><i class="ci-hk-arrow-29" aria-hidden="true"></i> {!$Label.Back}</a></p>
                </div>
            </div>
            <div id="papaer-app" class="bs row cigna-content-area cigna-fg-gray-dark" style="padding-bottom: 50px;">
                <div class="snd-loading-div">
                    <span id="snd-loading-phurl" style="display: none;">
                        <div class="bs col-xs-12 col-lg-12 loading-div">
                            <span class="loading-helper"></span>
                            <i class="spinner-icon fa fa-spinner fa-pulse fa-3x fa-fw"></i>
                            <span class="sr-only">Loading...</span>
                        </div>
                    </span>
                </div>
                
                <div class="bs col-xs-12">
                    <!-- Rancho_HKITSFDC264_20250903 - update font -->
                    <div class="bs col-xs-12"><h3 class="bs cigna-fg-navy-blue">{!selectedProduct.name__c}</h3></div>
                </div>
                <!--
                <div class="bs col-xs-12">
                    <div class="bs col-xs-12" style="font-weight: 500;">
                        <p><br/>{!$Label.eSales_select_file_to_submitted}</p>
                    </div>
                </div>
                -->
                <div class="bs col-xs-12">
                    <div class="bs col-xs-12">
                        <p><br/>{!$Label.eSales_Paper_Application_Statement_1}</p>
                    </div>
                </div>
                
                <div class="bs col-xs-12">
                    <div class="bs col-xs-12">
                        <p>{!$Label.eSales_Paper_Application_Statement_2}</p>
                    </div>
                </div>

                <div class="bs col-xs-12 form-horizontal">
                    <div id="errFileSize" class="alert alert-danger" role="alert" style="display:none;">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                        {!$Label.File_size_exceeds_10M}
                    </div>
                    <div id="errFileType" class="alert alert-danger" role="alert" style="display:none;">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                        {!$Label.Please_upload_a_valid_file} (i.e. .pdf/.jpeg/.png/.tiff/.gif)
                    </div>
                    <div id="errNoFile" class="alert alert-danger" role="alert" style="display:none;">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                        {!$Label.ErrMasg_Upload_Att}
                    </div>
                    <div id="errUpdateAllFile" class="alert alert-danger" role="alert" style="display:none;">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                        {!$Label.eSales_Paper_Application_Required}
                    </div>
                    <div id="errOnlyAllowOneFile" class="alert alert-danger" role="alert" style="display:none;">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                        {!$Label.eSales_Paper_Application_Only_allow_one_file}
                    </div>
                </div>

                <div id="downloadDocPanel" class= "bs col-xs-12 onclick-pointer form-horizontal"> 
                    <br/>
                    <div class="bs col-xs-12 onclick-pointer form-field" style="font-weight: 500;">
                        <!-- Rancho_JOBR362_20240226 - redirect to useful form -->
                        <!-- <a href="{!$Setup.Portal_Settings__c.File_Download_URL__c}{!PaperApplicationUrl}" target="_blank"> -->
                        <a href="javascript:void(0);" onclick="Cigna.Util.navigateToVFP('UsefulFormVFP')" target="_blank">
                            <!--<i class="ci-hk-inbox content-icon" aria-hidden="true"></i><span style="color:#666666;">{!$Label.eSales_Download_Application_Form}</span>
                            <span style="color:#666666;" class="ci-hk-inbox content-icon" aria-hidden="true">{!$Label.eSales_Download_Application_Form}</span>-->
                            <span class="ci-hk-inbox content-icon" aria-hidden="true"></span>
                            <span style="color:#666666;">{!$Label.eSales_Download_Application_Form}</span>
                        </a>
                        
                    </div>

                </div>
                
                
                <div class="bs col-xs-12 form-horizontal">
                
                    <apex:outputPanel id="uploadatt">
                        <script>
                            //CR-56_Link_20220214
                            $('[data-toggle="tooltip"]').tooltip();
                        </script>

                        <br/>
                        <br/>

                        <div class="bs row col-xs-12">
                            <div class="col-xs-10 col-sm-10" style="font-weight: 500;">
                                <input id="User_PaperAPP" type="file" multiple="multiple" class="fileInput cigna-validation" onchange="Cigna.PaperApp.uploadFile('{!fileStoreId}','User_PaperAPP');" style="display:none;"/>
                                <label for="User_PaperAPP"><i class="ci-hk-outbox content-icon onclick-pointer" aria-hidden="true"/></label>
                                {!$Label.eSales_Upload_Application_Form}
                            </div>
                            <div class="col-xs-2 col-sm-1"><i class="ci-hk-help helptext-icon pull-right" data-toggle="tooltip" title="{!$Label.eSales_paper_app_Upload_Tips}" aria-hidden="true"></i></div>
                            <div class="col-xs-12 col-sm-12" style="padding-bottom:10px;"></div>
                            <div style="padding:20px;">
                                <apex:outputPanel id="hkidlist">
                                    <apex:repeat value="{!PaperAppList}" var="idAtt">
                                        <div att-type="User_PaperAPP" class="col-xs-12 col-sm-12 uploaded-filelist">
                                        {!idAtt.Name}
                                        <i class="ci-hk-x pull-right onclick-pointer" onclick="removeAttachment('{!idAtt}');" aria-hidden="true"></i></div>
                                        <div class="col-xs-12 col-sm-12" style="padding-bottom:5px;"></div>
                                    </apex:repeat>
                                </apex:outputPanel>
                            </div>

                        </div>

                       
                    </apex:outputPanel>
                    <br/>
                    <br/>

                </div>

                <div class="bs col-sm-12 col-xs-12">
                   
                   <!--desktop action button-->
                    <div id="paperSubmit" class="bs hidden-xs hidden-md col-sm-4 col-sm-offset-4 cigna-fg-white cigna-bg-orange-dark desktop-action-btn onclick-pointer" onclick="Cigna.PaperApp.submitDoc();">
                        {!$Label.Submit}
                    </div>

                    <div id="paperSubmit2" class="bs visible-md col-sm-4 col-sm-offset-4 cigna-fg-white cigna-bg-orange-dark desktop-action-btn onclick-pointer " style="padding-bottom: 20px;" onclick="Cigna.PaperApp.submitDoc();">
                        {!$Label.Submit}
                    </div>

                    
                   <!--mobile action button-->    
                    <div id="mobile-app-padding" class="bs row" style="display: none; padding-bottom: 100px;">
                        <div class="bs col-xs-12"></div>
                    </div>
                
                    <!--<div id="action-bar" class="bs visible-xs cigna-floating-bottom-panel" style="left:0px;">
                        <div id="eSignaturetnxs" class="bs cigna-action-btn-group cigna-fg-white cigna-bg-orange-dark onclick-pointer" onclick="Cigna.PaperApp.submitDoc();">
                            <a class="action-btn cigna-fg-white" role="button"><span class="ci-hk-document-send" aria-hidden="true"></span><br/><span id="eSignaturebtnxstext">{!$Label.Submit}</span></a>
                        </div>
                    </div>-->
               </div>
                   
            </div>
            
            <div id="mobile-app-padding" class="bs row" style="display: none; padding-bottom: 100px;">
                <div class="bs col-xs-12"></div>
            </div>
            <!--
            <script>
                
                if (Cigna.Util.isSalesforce1()) { 
                    $('#mobile-app-padding').css('display', 'block');
                    $("a").attr("target","");
                }
                
            </script>
            -->
        </apex:outputPanel>

        <apex:outputPanel id="aftersubmitted_pass" styleClass="bs row" layout="block" rendered="{!resultPart}">
            <div class="bs col-xs-12 col-sm-8 col-sm-offset-2" style="text-align:center;">
                <i class="fa fa-check-circle-o content-active cigna-fg-green-medium" style="font-size:50px;" aria-hidden="true"></i>
            </div>
            <div class="bs col-xs-12 col-sm-8 col-sm-offset-2" style="text-align:center;">
                <p>{!$Label.eSales_Paper_Application_Result}</p>
                
            </div>
            
            <div id="action-bar-desktop" class="bs hidden-xs text-center">
                
                <a id="eSales-home-btn" href="#" class="bs btn action-btn cigna-fg-white cigna-bg-orange-dark cigna-btn-desktop" 
                    role="button" onclick="Cigna.PaperApp.goHome();">
                    {!$Label.Home}
                </a>  
            </div>
            <!--<div id="action-bar" class="bs cigna-floating-bottom-panel visible-xs">
                <div class="bs cigna-action-btn-group cigna-fg-white cigna-bg-orange-dark">
                    <a id="eSales-home-btn" href="#" class="action-btn cigna-fg-white" role="button" 
                       onclick="Cigna.PaperApp.goHome();">
                       <i class="ci-hk-home" aria-hidden="true"></i><br/>
                        {!$Label.Home}
                    </a> 
                </div>
            </div>-->
            <script>
                if (Cigna.Util.isIOS() && Cigna.Util.isSalesforce1() && Cigna.Util.isBrokerPortal()) {
                    $('#mobile-app-padding').css('display', 'block');
                    
                    /*$('html').css('position', 'fixed').css('overflow', 'auto').css('width', '100%').css('height', '100%');
                    $('body').css('position', 'fixed').css('overflow-x', 'scroll').css('width', '100%').css('height', '100%');*/
                    
                    $("a").attr("target","");
                }
                
            </script>    
        </apex:outputPanel>
        
        <script>
                
            if (Cigna.Util.isSalesforce1()) { 
                $('#mobile-app-padding').css('display', 'block');
                $("a").attr("target","");
            }
            
        </script>
        
   </apex:form>
</apex:page>
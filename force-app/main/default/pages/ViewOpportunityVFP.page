<apex:page standardController="Opportunity" extensions="ViewOpporVFPCtrl" docType="html-5.0" tabStyle="Opportunity">
    <script  type="text/javascript">
        // block page showing  in IE brower
        (function isIE11below() { //ie?
            if (!!window.ActiveXObject && {!wortAtHome}) {
                console.log('coming ie11');
                window.opener = null;
                window.open("about:blank", "_self");
                window.close();
            }
        })();
    </script>
    <style>
        .accountAirView{
            width: 320px;
            position: absolute;
            z-index: 15;
            top: 0;
            left: 0;
            display: none;
            padding: 0;
            margin: 0;
        }
        /* .accountAirView :hover{
            display: block;
        } */
    </style>
    <apex:includeScript value="/soap/ajax/49.0/connection.js"/>
    <apex:includeScript value="/support/console/49.0/integration.js"/>
    <div id="airView" class="accountAirView" onfocus="focusAir();" onmouseover="focusAir();" onblur="hideAirViewLater()" onmouseout="hideAirViewLater()">
        <apex:pageBlock title="Person Account" mode="detail">
            <apex:pageBlockButtons location="top">
                <apex:outputPanel ><div class="btn" onclick="redirectInConsole('/{!acc.id}');" >View</div></apex:outputPanel>
                <apex:outputPanel ><div class="btn" onclick="redirectInConsole('/{!acc.id}/e');" >Edit</div></apex:outputPanel>
            </apex:pageBlockButtons>
            <apex:pageBlockSection columns="1">
                <apex:pageBlockSectionItem >
                    <apex:outputLabel >{!$ObjectType.Account.Fields.Name.Label}</apex:outputLabel>
                    <apex:outputField value="{!acc.Name}"/>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel >{!$ObjectType.Account.Fields.PersonMobilePhone.Label}</apex:outputLabel>
                    <apex:outputField value="{!acc.PersonMobilePhone}"/>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel >{!$ObjectType.Account.Fields.Gender__c.Label}</apex:outputLabel>
                    <apex:outputField value="{!acc.Gender__c}"/>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
        </apex:pageBlock>
    </div>
    <apex:detail title="true" showChatter="true" inlineEdit="{!!wortAtHome}"/>
    
    <script  type="text/javascript">
            var workAtHome = {!wortAtHome};
            var timeoutIdList=[];

            if(!Array.indexOf){
                Array.prototype.indexOf = function(obj){              
                    for(var i=0; i<this.length; i++){
                        if(this[i]==obj){
                            return i;
                        }
                    }
                    return -1;
                }
            }
            // fix the content due to overriding view page causes that shows 'External Page' text on tab
            function resetTabContent() {

                let primaryTabId = '';
                let subTabId = '';
                let primaryTabObjId = '';
                let subTabObjId = '';

                sforce.console.getFocusedPrimaryTabId(function(result) {
                    primaryTabId = result.id;
                });

                sforce.console.getFocusedSubtabId(function(result) {
                    subTabId = result.id;
                });

                sforce.console.getFocusedPrimaryTabObjectId(function(result) {
                    primaryTabObjId = result.id;
                });
                sforce.console.getFocusedSubtabObjectId(function(result) {
                    subTabObjId = result.id;
                    if(primaryTabObjId == subTabObjId ) {
                        sforce.console.setTabTitle('{!Opportunity.Name}', primaryTabId);
                        sforce.console.setTabIcon("{!URLFOR($Resource.objectIcon, 'opportunityicon_16x16.png')}", primaryTabId);
                    } else {
                        sforce.console.setTabTitle('{!Opportunity.Name}', subTabId);
                        sforce.console.setTabIcon("{!URLFOR($Resource.objectIcon, 'opportunityicon_16x16.png')}", subTabId);
                    }
                });
            }

            var pageLoad = window.onload;
            window.onload = function() {
                if (pageLoad) {
                    debugger
                        pageLoad();
                }
                if(sforce.console.isInConsole()){
                    
                    resetTabContent();
                }
            }

            // @param retainLen - retain original lenght and other chart will be masked
            function maskData(origData, retainLen) {

                var processData = origData;
                if(processData && origData.length > retainLen) {

                    var maskLen = origData.length - retainLen;
                    var maskStr = '';
                    for(var i = 0; i < maskLen; i++) {
                        maskStr+= '*';
                    }
                    processData = origData.substring(0, retainLen) + maskStr;

                }

                return processData;
            }

            function preKey(keys){
                var data=["/",".","*","+","?","|","(",")","[","]","{","}"];
                var data2=["\\/","\\.","\\*","\\+","\\?","\\|","\\(","\\)","\\[","\\]","\\{","\\}"];
                
                for(var count = 0; count<data.length;count++){
                    if(keys.indexOf(data[count])>-1) {
                        var reg = new RegExp(data2[count], 'g');
                        keys=keys.replace(reg, data2[count]);
                    }
                }
                return keys;
            }

            // Mask sensitive data when user work at home
            let maskCallBack = function(){
                if(!workAtHome) {
                    return null;
                }

                const maskPhoneLabelArr = ['Phone', 'Mobile', 'Mobile Phone', 'Home Phone', 'Office Phone'];
                const hideAccountLabel= ['Account Name'];
                // get all label elements
                const labelEles = document.querySelectorAll("td.labelCol");

                // console.log('labelEles:', labelEles);
                for (let i = 0; i < labelEles.length; i++) {
                    const currentEle = labelEles[i];

                    let labelTxt = currentEle.innerText;

                    if(maskPhoneLabelArr.indexOf(labelTxt) != -1) {

                        // value element
                        let valueEle = currentEle.nextElementSibling;
                        let valueText = valueEle.innerText;
                        
                        if(valueText && valueText.trim()) {

                            let valueInnerHtml = valueEle.innerHTML;
                            if(maskPhoneLabelArr.indexOf(labelTxt) != -1 && valueInnerHtml.indexOf("<img") != -1) {
                                let phoneTextValue = valueEle.textContent;
                                valueText = phoneTextValue.substring(0, phoneTextValue.length/2);
                            }

                            let preValueText = preKey(valueText);
                            let regStr = ">" + preValueText + "<";
                            let reg = new RegExp(regStr, 'g');

                            let matchResultArr = valueInnerHtml.match(reg);
                            // console.log('coming4', matchResultArr);
                            // console.log("matchResultArr: ", matchResultArr);
                            if(matchResultArr != null) {

                                // mask data
                                let value = matchResultArr[0];
                                let maskedValue = '';
                                
                                maskedValue = maskData(value, 5);
                                

                                //replace original html
                                let regRplc = new RegExp(value, 'g');
                                valueEle.innerHTML = valueInnerHtml.replace(regRplc, maskedValue + '<');

                                valueEle.classList.add("masked");
                            } else {
                                //<td>fasdf23423</td>
                                // note: only has textcontent, hasn't other inner html
                                let maskedValue = maskData(valueText, 4);
                                
                                let preValueText = preKey(valueText);
                                let regRplc = new RegExp(preValueText, 'g');
                                valueEle.innerHTML = valueInnerHtml.replace(regRplc, maskedValue);
                                valueEle.classList.add("masked");
                            }
                        }

                    }else if(hideAccountLabel.indexOf(labelTxt) != -1){
                        let valueEle = currentEle.nextElementSibling;
                        let valueLink = valueEle.getElementsByTagName("a");
                        console.log("find the a tag in value,:"+valueLink);
                        if(valueLink){
                            for (let index = 0; index < valueLink.length; index++) {
                                const element = valueLink[index];
                                // element.addEventListener("focus",(event) => {
                                //     displayAirView(event.target)
                                // });
                                element.href="javascript:redirectInConsole('/{!acc.id}');"
                                element.onfocus==function(){
                                    displayAirView(element);
                                };
                                // console.log(element.onfocus);
                                element.onmouseover=function(){
                                    displayAirView(element);
                                };
                                // element.addEventListener("mouseover",(event) => {
                                //     displayAirView(event.target)
                                // });
                                // element.addEventListener("blur",hideAirView);
                                // element.addEventListener("mouseout",hideAirView);
                                element.onblur=hideAirViewLater;
                                element.onmouseout=hideAirViewLater;
                            }
                            
                        }
                    }
                }
            }

            // callback when DOM is ready
            document.addEventListener("DOMContentLoaded", maskCallBack());

            function displayAirView(ele){
                console.log('displayAirView ele'+ele);
                var airView=document.getElementById('airView');
                var rect = ele.getBoundingClientRect();
                var bodyrect = document.body.getBoundingClientRect();
                airView.style.top=(rect.top-bodyrect.top)+'px';
                airView.style.left=rect.right+'px';
                console.log(airView.style.top);
                console.log(airView.style.left);
                focusAir();
                airView.style.display="block";
            }

            function hideAirViewLater(){
                const thetimeoutId = setTimeout(hideAirView, 500); 
                timeoutIdList.push(thetimeoutId);
            }

            function hideAirView(){
                var airView=document.getElementById('airView');
                airView.style.display="none";
            }

            function focusAir(){
                for (let index = 0; index < timeoutIdList.length; index++) {
                    const timeoutid = timeoutIdList[index];
                    clearTimeout(timeoutid);
                }
            }

            function redirectInConsole(url){
                if(sforce.console.isInConsole()){
                    srcUp(url);
                }else{
                    window.open(url,'_blank');
                }
            }
    </script>
</apex:page>
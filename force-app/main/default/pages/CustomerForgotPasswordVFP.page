<!--Please change apex page id and Portal Template Page-->
<apex:page docType="html-5.0" id="CustomerPortalTemplatePage" showHeader="false" title="{!$Label.site.forgot_password}" controller="ForgotPasswordController" language="{!JSINHTMLENCODE($CurrentPage.Parameters.lang)}">

    <head>
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width"/>
        <!-- CR-56_Link_20220214 -->
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/jquery-3.6.0.min.js')}"/>
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/jquery-migrate-3.3.2.js')}"/>
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/bootstrap3.4.1.min.js')}"/>
        <apex:include pageName="CignaUtilJS"/>
    </head>
    
    <style>
        span[id$="cigna-error"] span div.message{
            border: none;
            margin-left: 0px;
            //background-color: #cc0000;
            background-color: #fff;
            //background-color: transparent;
            opacity: .9;
        }
        
        span[id$="cigna-error"] span div.message table.messageTable tbody tr td img{
            display: none;
        }
        
        span[id$="cigna-error"] span div.message table.messageTable tbody tr td.messageCell div span{
            display: none;
        }
        
        span[id$="cigna-error"] span div.message table.messageTable tbody tr td.messageCell{
            //color: #fff;
            //color: #F68621;
            color:red;
            font-family: "Gotham SSm A", "Gotham SSm B";
        }
        
        span[id$="cigna-error"] .messageText::before{
            content: "\f071\20";
            font: normal normal normal 14px/1 FontAwesome;
            font-size: inherit;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
            padding-right: 7px;
        }

        .inputfieldstyle{
            box-shadow: none !important;
            border-radius: 0px !important;
            -webkit-box-shadow: none !important;
            -moz-box-shadow: none !important;
            border:0px !important;
            border-bottom:1px solid #FFF !important;
            background: transparent !important;
            color: #FFF !important;
        } 
        .LogoDiv {
            text-align:center;
            padding-bottom: 2cm;
            margin: 15px;
            margin-bottom: 90px;
        }
        /* PI-114 20230731, commented by Owen to remove chubb*/
        /*#closeForgotPasswordPopUp{
            position: absolute;
            top: 10px;
            right: 10px;
        }
        div#forgotPasswordPageOverlay {
            display: none;
            z-index: 10;
            background: #D9D9D6;
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0px;
            left: 0px;
            text-align: center;
        }
        @media (max-width: 767px) {
            div#forgotPasswordPageOverlayPagePop {
                display: none;
                position: absolute;
                z-index: 11;
                margin: 100px auto 0px auto; 
                width: 80%;
                max-height: 70%;
                overflow-y: auto;
                background: #ffff;
                color: #000;
                left: 5%;
                padding: 20px;
                border-radius: 5px;
            }
        }
        @media (min-width: 768px) {
            div#forgotPasswordPageOverlayPagePop {
                display: none;
                position: absolute;
                z-index: 11;
                margin: 124px auto;
                width: 40%;
                max-height: 70%;
                overflow-y: auto;
                background: #ffff;
                color: #000;
                left: 30%;
                padding: 20px;
                border-radius: 5px;
            }
        } */   
    </style>
    <script type="text/javascript">
        var isIOSApp = false;
        $(document).ready(function(){
            $('[id$="send"]').attr("disabled", 'disabled'); 
            // PI-22 jack add
            if(Cigna.Util.isIOS() && Cigna.Util.checkWebView()){
                isIOSApp = true;
                $('[id$="send"]').removeAttr("disabled"); 
                $('[id$="recaptchaDiv"]').hide();
            }
            // PI-22 jack add
            $('.LogoDiv').css('margin-bottom','90px');
        });
        function refreshIsSuccess(){
            if($('[id$="isSuccess"]').val()=='true' && $('[id$="hasError"]').val()=='false'){
                $('[id$="send"]').removeAttr("disabled"); 
                 hasReCAPTCHAError = false;
            }else{
                $('[id$="send"]').attr("disabled", 'disabled'); 
                hasReCAPTCHAError = true;
            }
            
        } 
        var hasReCAPTCHAError = false;
        var verifyCallback = function(response) {
            //hasToken();
            var res = response;
            verifyResponse(response);
        };
        var widgetId3;
        var siteKey = '{!$Setup.Portal_Settings__c.ReCAPTCHA_Site_Key__c}';
        var onloadCallback = function() {
            console.log('onloadCallback');
            widgetId3 = grecaptcha.render('recaptchaDiv', {
                'sitekey' : siteKey,
                'callback' : verifyCallback,
                'expired-callback': onRecaptchaExpired,
                'theme' : 'clean'
            });
        };
        function validateAndSubmit(){
            var inputName = $('[id$="username"]').val();
            forgotPassword(inputName, hasReCAPTCHAError, isIOSApp);//PI-22 jack add
            // forgotPassword(inputName, hasReCAPTCHAError, true);
        }
        var date_ymd = /^(\d{4})-(0\d{1}|1[0-2])-(0\d{1}|[12]\d{1}|3[01])$/;
        
        function validateResetPasswordEmail(){
            $('[id$="errorTable"]').css('display','none');
            $('#ssnErrorMsg').css('display','none');
            $('#dobErrorMsg').css('display','none'); 

            var idNo = $('[id$="idNo"]').val();
            if((typeof(idNo) == "undefined") || idNo == ''){
                //var ssnErrorMsg = $('[id$="ssnErrorMsg"]').html();
                $('#ssnErrorMsg').css('display','block');
                return false;
            }else{
                $('#ssnErrorMsg').css('display','none');
            }
            var ddDOB = $('[id$="ddDOB"]').val();
            var mmDOB = $('[id$="mmDOB"]').val();
            var yyyyDOB = $('[id$="yyyyDOB"]').val();
            var birthday = yyyyDOB + '-' + mmDOB + '-' + ddDOB;
            if(!date_ymd.test(birthday)){
                //var dobErrorMsg = $('[id$="dobErrorMsg"]').html();
                $('#dobErrorMsg').css('display','block'); 
                return false;
            }else{
                $('#dobErrorMsg').css('display','none'); 
            }
            //sendResetPasswordEmail();
            forgotPassword();
            $('[id$="sendEmailButton"]').attr("disabled", 'disabled'); 
        }
       var onRecaptchaExpired=function recaptchaExpired(){
            hasReCAPTCHAError = true;
            $('[id$="send"]').attr("disabled", 'disabled'); 
        }
        
        
        // PI-114 20230731, commented by Owen to remove chubb
        // function showLoading() {
        //     $('#login-input-area').fadeOut(100, function(){
        //         $('#login-loading').fadeIn(100);
        // });}
    </script>
    <!-- PI-114 20230731, commented by Owen to remove chubb -->
    <!-- <apex:outputPanel id="forgotjqForm">  
        <script>
            function toggleForgotPageOverlay(){
                console.log('toggleForgotPageOverlay');
                var overlay = document.getElementById('forgotPasswordPageOverlay');
                var specialBox = document.getElementById('forgotPasswordPageOverlayPagePop');
                overlay.style.opacity = .95;
                console.log('overlay.style.display='+overlay.style.display);
                if({!displayForgetPassword} == true){
                    if (overlay.style.display == 'none') {
                        console.log('forgotPasswordPageOverlay block');
                        overlay.style.display = "block";
                        specialBox.style.display = "block";
                    } else {
                        console.log('forgotPasswordPageOverlay none');
                        overlay.style.display = "none";
                        specialBox.style.display = "none";
                    }
                }
            }
        </script>
    </apex:outputPanel> -->
    <!-- PI-114 20230731, commented by Owen to remove chubb -->
    <!-- <apex:outputPanel id="forgetPasswordForm">
        <div id="forgotPasswordPageOverlay" style="display:none;">
            <div id="forgotPasswordPageOverlayPagePop" class="bs">
                <apex:outputPanel rendered="{!chubbUserType=='4'}" layout="block" style="text-align: left;">
                    <a href="javascript:void(0);" class="onclick-pointer" ><div id="closeForgotPasswordPopUp" class="glyphicon glyphicon-remove" onclick="toggleForgotPageOverlay();"></div></a>
                    <div class="bs col-md-12 col-xs-12" style="font-size:20px;">
                        <apex:form >
                            <apex:commandButton action="{!cignaSetPassword}" value="{!$Label.Reset_Cigna_Password}" onclick="showLoading();toggleForgotPageOverlay();"  rerender="errorTable,forgetPasswordForm" styleClass="bs btn btn-primary btn-block" style="font-family: Arial,Helvetica,sans-serif;"/>
                            <br />
                            <div>
                                <apex:commandButton action="{!chubbSetPassword}" value="{!$Label.Reset_Chubb_Password}" onclick="showLoading();toggleForgotPageOverlay();"  rerender="errorTable,forgetPasswordForm" styleClass="bs btn btn-primary btn-block" style="font-family: Arial,Helvetica,sans-serif;"/>
                            </div>
                        </apex:form>
                    </div>
                </apex:outputPanel>
            </div>
        </div>
    </apex:outputPanel> -->
    <!-- Start of the page template -->
    <apex:composition template="CustomerUnauthorizedPageTemplate">
        <!-- Start of the main body -->
        
        <apex:define name="body">
            

                <div class="bs col-xs-12 col-md-12">
                    <h4>{!$Label.site.forgot_your_password_q}</h4>
                    <apex:outputPanel id="reminderDiv">              
                        <!--Tovid_20200428_add Enhancement-->
                        <br/>
                        <br/>
                        <p>
                            <h5><!--<i>-->
                                <!-- Rancho_JOBR300_20230214 - replace label with custom metadata type record -->
                                <apex:outputPanel ><apex:outputText value="{!transField['RegisterReminder1'][$Label.Header_Language_Code_Current]}{!transField['RegisterReminder3'][$Label.Header_Language_Code_Current]}"  escape="false" /></apex:outputPanel>
                            </h5><!--</i>-->
                        </p>
                    </apex:outputPanel>
                </div> 
                <div class="col-xs-12 col-md-12">                    
                    <apex:outputPanel id="errorTable">
                        <apex:inputHidden value="{!hasError}" id="hasError"/> 
                        <apex:outputPanel rendered="{!hasError}">
                            <span id="CustomerPortalTemplatePage:cigna-error">
                                <span>
                                    <div class="message errorM3" role="alert">
                                        <table border="0" cellpadding="0" cellspacing="0" class="messageTable" style="padding:0px;margin:0px;">
                                            <tbody>
                                                <tr valign="top">
                                                    <td><img alt="ERROR" class="msgIcon" src="/s.gif" title="" data-original-title="ERROR" /></td>
                                                    <td class="messageCell">
                                                        <div class="messageText">
                                                            <!-- Rancho_JOBR300_20230214 - escape html characters in label -->
                                                            <span style="color:#cc0000"><h4>{!$Label.site.error2}</h4></span><apex:outputText value="{!errorMessage}" escape="false"/>
                                                            <br />
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </span>
                            </span>
                        </apex:outputPanel>
                    </apex:outputPanel>
                </div>
                <div id="ssnErrorMsg" class="col-xs-12 col-md-12" style="display: none;">                    
                    <apex:outputPanel id="ssnErrorMsgPanel">
                        <apex:outputPanel >
                            <span id="ssnErrorMsgPanel:cigna-error">
                                <span>
                                    <div class="message errorM3" role="alert">
                                        <table border="0" cellpadding="0" cellspacing="0" class="messageTable" style="padding:0px;margin:0px;">
                                            <tbody>
                                                <tr valign="top">
                                                    <td><img alt="ERROR" class="msgIcon" src="/s.gif" title="" data-original-title="ERROR" /></td>
                                                    <td class="messageCell">
                                                        <div class="messageText">
                                                            <span style="color:#cc0000"><h4>{!$Label.site.error2}</h4></span>{!transField['Forgot_Pass_Error_101'][$Label.Header_Language_Code_Current]}
                                                            <br />
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </span>
                            </span>
                        </apex:outputPanel>
                    </apex:outputPanel>
                </div>
                <div id="dobErrorMsg" class="col-xs-12 col-md-12" style="display: none;">                    
                    <apex:outputPanel id="errorTablePanel">
                        <apex:outputPanel >
                            <span id="errorTablePanel:cigna-error">
                                <span>
                                    <div class="message errorM3" role="alert">
                                        <table border="0" cellpadding="0" cellspacing="0" class="messageTable" style="padding:0px;margin:0px;">
                                            <tbody>
                                                <tr valign="top">
                                                    <td><img alt="ERROR" class="msgIcon" src="/s.gif" title="" data-original-title="ERROR" /></td>
                                                    <td class="messageCell">
                                                        <div class="messageText">
                                                            <span style="color:#cc0000"><h4>{!$Label.site.error2}</h4></span>{!transField['Forgot_Pass_Error_102'][$Label.Header_Language_Code_Current]}
                                                            <br />
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </span>
                            </span>
                        </apex:outputPanel>
                    </apex:outputPanel>
                </div>
                <!--show the error msg for invoke--> 
                <!-- Rancho_JOBR300_20230214 - add identity type dropdown list for user select -->
                <div class="bs form-group col-xs-12 col-md-12">
                    <p>{!transField['Identity_Type'][$Label.Header_Language_Code_Current]}</p>
                    <apex:selectList value="{!identityType}" size="1" styleClass="form-control">
                        <apex:selectOption itemValue="{!transField['HKID']['en_US']}" itemLabel="{!transField['HKID'][$Label.Header_Language_Code_Current]}"></apex:selectOption>
                        <apex:selectOption itemValue="{!transField['Passport_number']['en_US']}" itemLabel="{!transField['Passport_number'][$Label.Header_Language_Code_Current]}"></apex:selectOption>
                        <apex:selectOption itemValue="{!transField['Member_ID']['en_US']}" itemLabel="{!transField['Member_ID'][$Label.Header_Language_Code_Current]}"></apex:selectOption>
                    </apex:selectList>
                </div>
                <div class="form-group col-xs-12 col-md-12">
                    <div id="input-id-div">
                        <apex:inputText value="{!ssnId}" id="idNo" html-placeholder="{!$Label.HKID_Passport_number}" styleClass="form-control" />
                        <!-- required="true" -->
                        <span class="helptext-icon input-group-addon" id="help" data-toggle="tooltip" title="{!$Label.Registration_ID_Help_Text}"
                            style="display:none;">
                            <i class="fa fa-question-circle-o" aria-hidden="true"></i>
                        </span>
                    </div>
                </div>
                
                <div class="form-group col-xs-12 col-md-12">
                    {!$Label.Date_of_Birth}
                </div>
                
                <div class="form-inline col-xs-12 col-md-12" style="padding-bottom:30px;">
                    <apex:input type="tel" style="width:33%;" value="{!ddDOB}" id="ddDOB" html-placeholder="{!$Label.DD}" html-maxlength="2"
                        styleClass="form-control inputs col-xs-4 col-md-4 inputfieldstyle" />
                    <apex:input type="tel" style="width:33%;" value="{!mmDOB}" id="mmDOB" html-placeholder="{!$Label.MM}" html-maxlength="2"
                        styleClass="form-control inputs col-xs-4 col-md-4 inputfieldstyle" />
                    <apex:input type="tel" style="width:33%;" value="{!yyyyDOB}" id="yyyyDOB" html-placeholder="{!$Label.YYYY}" html-maxlength="4"
                        styleClass="form-control inputs col-xs-4 col-md-4 inputfieldstyle" />
                </div>

                <div class="bs form-group col-xs-12 col-md-12" style="display: none;">
                    <apex:inputText value="{!username}" id="username" html-placeholder="{!$Label.Registered_Email}" styleClass="form-control" html-autocomplete="email" /> <!-- required="true" -->
                    <br/>
                    <div id="recaptchaDiv"></div>
                    <script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit&hl={!JSINHTMLENCODE($CurrentPage.Parameters.lang)}" 
                        async='' defer=''>
                    </script>
                </div>
                <apex:actionFunction name="verifyResponse" action="{!verifyResponse}"  status="loader-icon" reRender="isSuccess,send,errorTable" oncomplete="refreshIsSuccess();">
                    <apex:param name="jsResponse" value="" assignTo="{!response}" />
                </apex:actionFunction>
                <apex:actionFunction name="forgotPassword" action="{!sendResetPasswordEmail}" status="loader-icon"  rerender="preForm, jqForm,errorTable" oncomplete="toggleForgotPageOverlay();onloadCallback();">
                    <!-- PI-114 20230731, commented by Owen to remove chubb, remove forgotjqForm,forgetPasswordForm -->
                    <!--<apex:param id="inputName" name="inputName" value=""/> -->
                    <!-- <apex:param id="hasReCAPTCHAError" name="hasReCAPTCHAError" value=""/> -->
                    <!-- <apex:param id="isIOS" name="isIOS" value="" /> --><!-- PI-22 jack add -->
                </apex:actionFunction>
                <apex:inputHidden value="{!isSuccess}" id="isSuccess"/>     
                <div class="col-xs-12 col-md-12" style="padding-top:10px; padding-bottom:10px;">
                    <apex:commandButton onclick="validateResetPasswordEmail();return false;" disabled="{!isForgetButtonDisabled}" value="{!$Label.Send_Password}" id="sendEmailButton" 
                        rerender="preForm, jqForm,errorTable" oncomplete="" styleClass="bs btn btn-primary btn-block"/>
                    <!-- <apex:commandButton onclick="validateAndSubmit();" value="{!$Label.Send_Password}" id="send" 
                        oncomplete="" styleClass="bs btn btn-primary btn-block"/> -->
                    <!-- <apex:commandButton action="{!doResetPassword}" value="Send Password" id="send" onclick="" rerender="preForm,test"
                    oncomplete="" styleClass="bs btn btn-primary btn-block"/> -->
                    <!-- uncomment this if need to test the reset password flow -->
                </div>
                    
                    
                <div class="col-xs-12 col-md-12" style="font-size: 1.1em;">
                    <br/>
                    <apex:outputLink value="{!$Label.Customer_Login_VFP}?lang={!JSINHTMLENCODE($CurrentPage.Parameters.lang)}">{!$Label.Return_To_Login_Page}</apex:outputLink> 
                </div>
                <div id="login-loading" class="bs col-xs-offset-3 col-xs-6 text-center" style="display:none;">
                    <img class="bs" src="{!URLFOR($Resource.Spinners, 'slds_spinner_inverse.gif')}" width="70px" />
                </div>
        </apex:define>
        <!-- End of the main body -->

    </apex:composition>
    <!-- End of the page template -->
</apex:page>
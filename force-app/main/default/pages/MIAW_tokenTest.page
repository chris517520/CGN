<apex:page >
<head> 
    <p id="StatusText">Initializing... </p>
    <textarea type="text" id="tokenInput" placeholder="Enter your token" />
    <button id="sendTokenButton">Login</button>
    <button id="cleanSession">Clear Session</button>
</head>
<script type='text/javascript'>
    function initEmbeddedMessaging() {
        try {
            embeddedservice_bootstrap.settings.language = 'zh-TW'; // For example, enter 'en' or 'en-US'
           
          
            window.addEventListener("onEmbeddedMessagingReady", () => {
                console.log("Received the onEmbeddedMessagingReady event…222 prechat");
               
                /*const userId = "0050p0000020rJI";
                  embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
                    "UserID" : userId 
                 });*/


                // Event listener for button click
                document.getElementById('sendTokenButton').addEventListener('click', () => {
                    var token = document.getElementById('tokenInput').value;
                     //token = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IjEyMzQifQ.eyJzdWIiOiJCQkIiLCJpc3MiOiJJc3N1ZXJTdXBwb3J0IiwiZXhwIjoxNzQ2Njg3NTc0fQ.kGIfx6U9FXor8sh1jVVEZpO51JPFCCwsIFw9z9tacIVbbue_eaQoLbElDXa0pcWQFXwLtRrn35jmrL5_l60H59rev6c0h8fam9tja1kzHFKG-rSjq4v1LO7pMUUikivohChNVg7_NyFZaWJWiYaHe_FJREivCgNqAaBUe1_3kJVCzlJD_om2LPvTDsi2z4k98_au-3esdgCk08JelD8fnrJdGdVi88-dBF6cVm5lvaoP5MiC_kc_x9XofbUlekalQ3jQPHQ5ISPmeQLqezm8Md_yCUrNzeUa7SPlPBGJer-DBY-0jbVF9nKB0UIvsYcrQ73ZTJNmMSNb9OmJT3R5gA";
                    // Send token to Salesforce
                    embeddedservice_bootstrap.userVerificationAPI.setIdentityToken({
                        identityTokenType: "JWT",
                        identityToken: token // Use the input token here
                    });

                    console.log("userVerificationAPI…");
                });
                
                document.getElementById('StatusText').innerText = "Ready to login";
            });
           
           //20250514
           window.addEventListener( "onEmbeddedMessagingConversationClosed", () => {

                console.log( "Inside Conversation End" );
            
                embeddedservice_bootstrap.userVerificationAPI.clearSession( true ).then( () => {
            
                    console.log( 'START::Remove Components' );
                    embeddedservice_bootstrap.utilAPI.removeAllComponents();
                    console.log( 'END::Remove Components' );
                    
                } );
            
            } );
            
             document.getElementById('cleanSession').addEventListener('click', () => {
                     embeddedservice_bootstrap.userVerificationAPI
                        .clearSession(true)
                        .then(() => {
                          // Add actions to run after the session is cleared successfully.
                           document.getElementById('StatusText').innerText = "Session cleared";
                        })
                        .catch((error) => {
                          // Add actions to run after clearing the session fails.
                          consol.elog('Clear session error');
                           document.getElementById('StatusText').innerText = "Session clear failed";
                        })
                        .finally(() => {
                          // Add actions to run whether the chat client launches
                          // successfully or not.
                        });
                    
                      // Add code to perform any other logout actions.
             });
            
            //20250514
            embeddedservice_bootstrap.init(
                '00D0p0000008cqz',
                'MIAW_Login_Channel',
                'https://cignahk--smuat.sandbox.my.site.com/ESWMIAWLoginChannel1753951975775',
                {
                    scrt2URL: 'https://cignahk--smuat.sandbox.my.salesforce-scrt.com'
                }
            );
        }
        catch (err) {
            console.error('Error loading Embedded Messaging: ', err);
        }
        finally {
            console.log("finally…");
        }

        window.addEventListener("onEmbeddedMessagingIdentityTokenExpired", () => {
            console.log("Received the onEmbeddedMessagingIdentityTokenExpired event.");
            // Add more code here.
        });
    }
</script>
<script type='text/javascript' src='https://cignahk--smuat.sandbox.my.site.com/ESWMIAWLoginChannel1753951975775/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>
</apex:page>
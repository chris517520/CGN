<apex:page showHeader="false" sidebar="false" standardStylesheets="false" controller="LiveChatController">

    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!-- CR-56_Link_20220214 -->
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/jquery-3.6.0.min.js')}"/>
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/jquery-migrate-3.3.2.js')}"/>
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/bootstrap3.4.1.min.js')}"/>
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'owl.carousel/owl.carousel_new.min.js')}"/>
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/signature_pad.min.js')}"></script>
        <apex:include pageName="CignaUtilJS"/>
        <style>
            body {
                margin: auto;
                background: #f9f9f9;
            }
            
            @font-face {
                font-family: MontserratLight;
                src: url("{!URLFOR($Resource.DD_Demo, 'fonts/Montserrat-Light.otf')}") format("opentype");
            }
            
            .bs {
                font-family: "MontserratLight", Arial, Helvetica, sans-serif;
            }
            
            .bs .navbar-toggle .icon-bar {
                background-color: #188CCC !important;
            }
            
            .bs .navbar-brand {
                padding: 10px !important;
            }
            
            #owl-promotion-mobile .item img {
                display: block;
                width: 100%;
                height: auto;
            }
            
            #owl-promotion-desktop .item img {
                display: block;
                width: 100%;
                height: auto;
            }
            
            @media (min-width: 1px) and (max-width: 768px) {
                .bs .navbar-nav li {
                    background-color: #004986 !important;
                    border-bottom: 0px solid #fff !important;
                }
                .bs .navbar-nav li > a {
                    color: #fff !important;
                }
            }
            
            .bs .navbar-nav li:hover {
                background-color: #fff !important;
            }
            
            .bs .navbar-nav li a:hover {
                color: #fff !important;
            }
            
            .bs div.section {
                position: absolute !important;
                left: 0 !important;
                width: 100% !important;
                background: #188CCC !important;
                padding-left: 5%;
            }
            
            .bs div.section > h4 {
                color: #FFF;
            }
            
            #record-list {
                font-size: 14px;
            }
            
            .fa-check-circle {
                color: #39B54A;
            }
            
            .fa-times-circle {
                color: #e80000;
            }
            
            .bs .btn-default {
                /*color: #fff !important;
                    background-color: #F1B434 !important;
                    border-color: #F1B434 !important;*/
            }
            
            .bs .btn-plain {
                color: #000 !important;
                background-color: #fff !important;
                border-color: #ddd !important;
            }
        </style>
        <!-- CR-56_Link_20220214 -->
        <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DD_Demo, 'css/bootstrap3.4.1.css')}" />
        <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DD_Demo, 'css/font-awesome.min.css')}" />
        <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DD_Demo, 'owl.carousel/owl.carousel.css')}" />
        <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DD_Demo, 'owl.carousel/owl.theme.css')}" />
        <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DD_Demo, 'owl.carousel/owl.transitions.css')}" />
    </head>

    <body class="bs" onload="fetchUsers()">
        <apex:remoteObjects jsNamespace="RemoteObjectModel">
            <apex:remoteObjectModel name="Contact" jsShorthand="userRec" fields="Id,Name,Phone,Email"></apex:remoteObjectModel>
            <apex:remoteObjectModel name="User" jsShorthand="userObject" fields="Id,Name,Phone,Contact_No_Country_Code__c,Contact_No__c,Email"></apex:remoteObjectModel>
        </apex:remoteObjects>
        <div class="bs container-fluid" style="padding-top: 50px;">
            <div id="record-list" class="bs row">
                <div class="bs col-xs-10 col-xs-offset-1 col-sm-8 col-sm-offset-2">
                    <apex:remoteObjects jsNamespace="Cigna">
                        <apex:remoteObjectModel name="Case" fields="Customer_Name__c,preferTime__c,Origin,Phone__c,Email__c" />
                    </apex:remoteObjects>
                    <apex:form id="frmLead">
                        <!--<label>We apologize that there is no service representative available now, please visit the <a href="">FAQ page</a> or leave us a message below</label>-->
                        <div class="bs form-group col-sm-12 col-xs-12" >
                        <label>
                            <apex:outputText value="{!$Label.LiveChatMessageToCase_Apologize}" escape="false">
                                <apex:param value="'FAQVFP'" />
                            </apex:outputText>
                        </label>
                        </div>
                        <div class="bs col-sm-12 col-xs-12" >
                            <label for="first_name">{!$Label.LiveChatMessageToCase_Customer_Name}:</label>
                        </div>
                        <div class="bs form-group col-sm-12 col-xs-12" >
                            <input id="myName" class="bs form-control" name="myName" type="text" placeholder="{!$Label.LiveChatMessageToCase_Customer_Name}" />
                        </div>
                        <div class="bs col-sm-12 col-xs-12" >
                            <label for="Email">{!$Label.LiveChatMessageToCase_Customer_Email}:</label>
                        </div>
                        <div class="bs form-group col-sm-12 col-xs-12" >
                            <input id="myEmail" class="bs form-control" name="myEmail" type="text" placeholder="{!$Label.LiveChatMessageToCase_Customer_Email}" />
                        </div>
                        <div class="bs col-sm-12 col-xs-12" >
                            <label for="Phone">{!$Label.LiveChatMessageToCase_Customer_Phone}:</label>
                        </div>
                        <div class="bs form-group col-sm-4 col-xs-4">
                            <input id="CountryCode" class="bs form-control" name="CountryCode" type="text" placeholder="+852" />
                        </div>
                        <div class="bs form-group col-sm-8 col-xs-8">
                            <input id="myPhone" class="bs form-control" name="myPhone" type="text" placeholder="{!$Label.LiveChatMessageToCase_Customer_Phone}" />
                        </div>
                        <div class="bs col-sm-12 col-xs-12" >
                            <label for="last_name">{!$Label.LiveChatMessageToCase_Customer_Prefer_Time}</label>
                        </div>
                        <div class="bs form-group col-sm-12 col-xs-12" >
                            <select id="preferTime" name="preferTime" class="bs form-control glance_masked">
                                <option value="{!$Label.LiveChatMessageToCase_AnyTime}">{!$Label.LiveChatMessageToCase_AnyTime}</option>
                                <option value="{!$Label.LiveChatMessageToCase_10am1pm}">{!$Label.LiveChatMessageToCase_10am1pm}</option>
                                <option value="{!$Label.LiveChatMessageToCase_1pm630pm}">{!$Label.LiveChatMessageToCase_1pm630pm}</option>
                                <option value="{!$Label.LiveChatMessageToCase_630pm9pm}">{!$Label.LiveChatMessageToCase_630pm9pm}</option>
                            </select>
                        </div>
                        <div class="bs col-sm-12 col-xs-12" >
                            <label for="first_name">{!$Label.LiveChatMessageToCase_Customer_Message}:</label>
                        </div>
                        <div class="bs form-group col-sm-12 col-xs-12" >
                            <textarea rows="4" id="myMessage" style="height:102px;" class="bs form-control" name="myMessage" type="text" placeholder="{!$Label.LiveChatMessageToCase_Customer_Message}" />
                        </div>
                        <div>
                            <div class="bs col-xs-12  col-sm-8 col-sm-offset-2" style="text-align: center">
                                <button onclick="closeWindow(); return false;" class="bs btn btn-default pull-middle">{!$Label.Close}</button>
                                <button id="case-submit-button" onclick="createCase(); return false;" class="bs btn btn-default pull-middle">{!$Label.LiveChatMessageToCase_Submit}</button>
                            </div>
                        </div>                     
                    </apex:form>
                </div>
            </div>
            <div id="responseDiv" class="bs col-xs-10 col-xs-offset-1 col-sm-8 col-sm-offset-2" style="display: none">
                <label>{!$Label.LiveChatMessageToCase_Message_Has_Been_Sent}</label>
                <div>
                    <div class="bs col-xs-12  col-sm-8 col-sm-offset-2" style="text-align: center">
                        <button  onclick="closeWindow();" class="bs btn btn-default pull-middle">{!$Label.OK}</button>
                    </div>
                </div>
            </div>
            <!-- <div id="recordList" class="bs row"> -->
        </div>
        <script type="text/javascript">
            function goToFAQPage(){
                var userType = "{!Text($User.userType)}";
                if(userType == 'Guest'){
                    Cigna.Util.navigateToVFP('FAQPublicVFP?lang={!$Label.Header_Language_Code_Current}', null, null, false, false)
                } else {
                    Cigna.Util.navigateToVFP('FAQVFP');
                }
            }
            
            //alert("{!Text($User.userType)}");
            function closeWindow() {
                var userType = "{!Text($User.userType)}";
                if(userType == 'Guest'){
                    Cigna.Util.navigateToVFP('CustomerLoginVFP', null, null, false, false)
                } else {
                    Cigna.Util.navigateToVFP('CustomerLandingPage', null, null, false, false)
                }
                /*
                var refUrl = document.referrer;
                console.log('ref:'+refUrl);
                if (Cigna.Util.checkWebView()) {
                    if(refUrl.indexOf('LiveChatLanding') != -1){
                        window.history.go(-1);
                    }else if(refUrl.indexOf('PreChat') != -1){
                        location.href = '{!$Setup.Portal_Settings__c.Customer_Portal_URL__c}/CustomerLoginVFP';
                    }else{
                        location.href = 'CustomerLandingPage';
                    }
                } else {
                    window.close();
                    window.history.go(-1);
                }*/
            }
        function closeWin()
        {
            // console.log(111);
            //window.close();
            // window.opener=null;
            // // window.open('','_self');
            // window.close();
            // this.window.opener = null;  
            // this.window.close();  
            
            self.opener=null;
            self.close();

        }
        
        function createCase() {
            $('#case-submit-button').attr("disabled","disabled");   //Nicole_2019.11.12_SPS-295            
            var userType = "{!Text($User.userType)}";                
            var contryCode = $('#CountryCode').val();
            if(contryCode == null || contryCode == ''){
                contryCode = '+852';
            }
            var ctDetails;
            if(userType == 'Guest'){
                ctDetails = {
                    Customer_Name__c: $('#myName').val(),
                    preferTime__c: $('#preferTime').val(),
                    Message__c: $('#myMessage').val(),
                    
                    //Email__c: $('#myEmail').val(),
                    //Phone__c: $('#myPhone').val(),
                    Contact_Email_of_Non_Existing_Customer__c: $('#myEmail').val(),
                    Contact_Phone_of_Non_Existing_Customer__c: $('#myPhone').val(),
                    Country_Code__c: contryCode,
                    Origin: "Web",
                    Media__c: 'Contact us (Live Chat)',
                    //JR124105 - Enhancement CS Service Console Case Picklist : update nature = Pending to handle    Zane 2021-11-08 
                    Nature__c: 'Pending to handle',
                    Non_One_And_Done_Reason__c: 'N/A',
                    Remarks__c: $('#myMessage').val(),
                    Prefer_Time__c:$('#preferTime').val()
                };
            }else{
                ctDetails = {
                    Customer_Name__c: $('#myName').val(),
                    preferTime__c: $('#preferTime').val(),
                    Message__c: $('#myMessage').val(),
                    
                    Email__c: $('#myEmail').val(),
                    Phone__c: $('#myPhone').val(),
                    Country_Code__c: contryCode,
                    Origin: "Web",
                    Media__c: 'Contact us (Live Chat)',
                    //JR124105 - Enhancement CS Service Console Case Picklist : update nature = Pending to handle    Zane 2021-11-08 
                    Nature__c: 'Pending to handle',
                    Non_One_And_Done_Reason__c: 'N/A',
                    Remarks__c: $('#myMessage').val(),
                    Prefer_Time__c:$('#preferTime').val()
                };
            }
            
            
            //alert($('#myEmail').val());

            var ct = new Cigna.Case();
            ct.create(ctDetails, function(err) {
                if (err) {
                    $('#case-submit-button').removeAttr("disabled");   //Nicole_2019.11.12_SPS-295
                    console.log(err);                    
                    alert(err.message);
                } else {
                    $("[id$='responseDiv']").css('display', 'block');
                    $("[id$='record-list']").css('display', 'none');
                    //alert("Your Message has send");

                    //console.log(ct.log());     // Dump contact to log
                    //console.log(ct.get('Id')); // Id is set when create completes

                }
            });


        }

        function redirectURL() {
            // window.location.href="http://www.dayanmei.com/"; 
            // $("[id$='LeadForm']").submit();
            // window.location.replace("../SunlifeAgent/DD_Acknowledge_Form_Lead");
            // window.location.replace("../apex/DD_Acknowledge_Form_Com");
            // alert("This lead has successfully synced to Salesforce");
            var sitePrefix = "<apex:outputText value=" {
                !IF(ISBLANK($Site.Prefix), 'BLANK', $Site.Prefix)
            }
            " />";
            var pageName = "";
            if (sitePrefix != "") {
                pageName = sitePrefix + pageName;
            }
            if ((typeof sforce != 'undefined') && sforce && (!!sforce.one)) {
                // Salesforce1 navigation
                sforce.one.navigateToURL(pageName);
            } else {
                // Set the window's URL using a Visualforce expression
                // alert(pageName);
                window.location.href = pageName;
            }
        }
        
        /*
        function fetchUsers() {
            // Create a new Remote Object
            var ur = new RemoteObjectModel.userObject();
            var myid = '{!$User.Id}';
            // alert(myContactid);
            if (myid == null) {
                return null;
            }
            ur.retrieve({
                where: {
                    Id: {
                        eq: myid
                    },
                },
                limit: 1
            }, function(err, records, event) {
                var userType = "{!Text($User.UserType)}";
                if (err) {
                    alert(err.message);
                } else {
                    console.log(records[0].get('Id'));
                    console.log(records[0].get('Name'));
                    console.log(records[0].get('Phone'));
                    console.log(records[0].get('Email'));
                    if(userType != 'Guest'){
                        $("[id$='myEmail']").val(records[0].get('Email'));
                        $("[id$='myName']").val(records[0].get('Name'));
                        var myPhone = '';
                        //if(records[0].get('Contact_No_Country_Code__c') != null && records[0].get('Contact_No_Country_Code__c') != undefined){
                        //    myPhone = myPhone + records[0].get('Contact_No_Country_Code__c');
                        //}
                        if(records[0].get('Contact_No__c') != null && records[0].get('Contact_No__c') != undefined){
                            myPhone = myPhone + records[0].get('Contact_No__c');
                        }
                        $("[id$='myPhone']").val(myPhone);
                        
                        var CountryCode = '';
                        if(records[0].get('Contact_No_Country_Code__c') != null && records[0].get('Contact_No_Country_Code__c') != undefined){
                            CountryCode = CountryCode + records[0].get('Contact_No_Country_Code__c');
                        }
                        $("[id$='CountryCode']").val(CountryCode);
                    }
                }
            });
        };
        */
        
        // Add by Manuel to fix the security issue
        function fetchUsers() {
            var userType = "{!Text($User.UserType)}";
            if(userType != 'Guest'){
                $("[id$='myEmail']").val('{!usrEmail}');
                $("[id$='myName']").val('{!usrName}');
                $("[id$='myPhone']").val('{!usrPhone}');
                $("[id$='CountryCode']").val('{!usrCountryCode}');
            }
        }

        </script>
    </body>
</apex:page>
<apex:page sidebar="false" controller="BDOpportunityBatchGenerateCtrl" tabStyle="Campaign"  title="Batch Generate Opportunity" lightningStylesheets="true" >
    <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/jquery.min.js')}"></script>
    <apex:stylesheet value="{!URLFOR($Resource.Cigna_HK_Icons, 'Cigna-HK-Icons.css')}"/>
    <style>
        .headerWrap{
            word-break:break-all;
            width:50px;
        }
        
        body select, body select[size='0'], body select[size='1'], .slds-scope select, .slds-scope select[size='0'], .slds-scope select[size='1']{
            height:31.2px;
        }
    </style>
    
    <apex:form id="memberListForm" style="width:100%;table-layout:fixed;word-break:break-all;">
        <apex:actionFunction name="getMemberList" namespace="MemberListSearch" action="{!getMemberList}" status="loader-icon" reRender="memberListPageBlock"/>
        <apex:actionFunction action="{!getIndividualPolicyList}" name="getIndividualPolicyList" status="loader-icon" reRender="individualPolicyInfoPanel" >
            <apex:param name="memberPolicyNoParam" assignTo="{!selectedMemberPolicyNo}" value="" />    
            <apex:param name="memberSSNParam" assignTo="{!selectedMemberSSN}" value="" />
            <apex:param name="memberFullNameParam" assignTo="{!selectedMemberFullName}" value="" />
        </apex:actionFunction>
        <apex:actionFunction name="previous" namespace="MemberListSearch" action="{!prevPage}" status="loader-icon" reRender="memberListPageBlock"/>
        <apex:actionFunction name="next" namespace="MemberListSearch" action="{!nextPage}" status="loader-icon" reRender="memberListPageBlock"/>
        <apex:actionFunction name="pPrevious" namespace="IndividualPolicyInfoSearch" action="{!pPrevPage}" status="loader-icon" rerender="individualPolicyInfoPanel"/>
        <apex:actionFunction name="pNext" namespace="IndividualPolicyInfoSearch" action="{!pNextPage}" status="loader-icon" rerender="individualPolicyInfoPanel"/>
        
        <apex:actionStatus id="loader-icon">
            <apex:facet name="start">
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.25; z-index: 1000; background-color: black;">
                     &nbsp;
                 </div>
                <div style="position: fixed; left: 0; top: 0; bottom: 0; right: 0; z-index: 1001; margin: 15% 50%">
                    <div style="display: inline-block; padding: 2px; background-color: #fff; width: 125px;">
                        <img src="/img/loading.gif" style="float: left; margin: 8px;" />
                        <span style="display: inline-block; padding: 10px 0px;">Please Wait...</span>
                    </div>
                 </div>
            </apex:facet>
        </apex:actionStatus>
        
        <apex:pageBlock id="batchGenOppPageBlock" mode="maindetail" >   
            <apex:outputPanel >
                <apex:pageMessages id="memberListMessage"></apex:pageMessages>
            </apex:outputPanel> 
            <apex:pageBlockSection columns="1" >
                <apex:pageblockSectionItem > 
                    <apex:outputpanel >
                        <apex:selectList value="{!selectedSearchType}" size="1">
                            <apex:selectoption itemLabel="{!$Label.Select_Search_Type}" itemValue="" itemDisabled="true"></apex:selectoption>
                            <apex:selectOptions value="{!searchType}"></apex:selectOptions>
                        </apex:selectList>
                        <apex:outputLabel >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</apex:outputLabel>
                        <apex:inputText value="{!searchValue}" />
                        <apex:outputLabel >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</apex:outputLabel>
                        <apex:commandButton value="Search" action="{!search}" status="loader-icon" reRender="memberListPageBlock,memberListMessage"/>
                    </apex:outputpanel>
                </apex:pageblockSectionItem>
            </apex:pageBlockSection>
                
            <apex:pageblockSection id="memberListPageBlock" columns="1">
                <apex:pageBlockTable value="{!memberWrapperList}" var="m" first="{!startIndex}" rows="{!pageSize}" rowClasses="onclick-pointer">                                      
                    <apex:column >
                        <apex:facet name="header"><apex:inputcheckbox id="selectAllCheckbox" value="{!selectAllFlag}" /></apex:facet>
                        <apex:inputcheckbox id="selectSingleCheckbox" value="{!m.isSelected}" />
                    </apex:column>
                    <apex:column headerValue="#"><div style="width:25px;">{!m.rowIndex }</div></apex:column>
                    <apex:column headerValue="{!$Label.Pol_Member_Cert_No}">{!m.person.certificateNo} </apex:column>
                    <apex:column headerValue="{!$Label.Pol_Member_Name}">{!m.person.fullName}</apex:column>
                    <apex:column headerValue="{!$Label.Pol_Relation}">{!m.person.insurableInterestReason}</apex:column>
                    <apex:column headerValue="{!$Label.Pol_Plan}">{!m.person.planNumber}</apex:column>
                    <apex:column headerValue="{!$Label.Pol_Effective_Date}">
                         <apex:outputText value="{0,date,yyyy/MM/dd}" escape="false">
                             <apex:param value="{!m.person.CertificateEffDateInDate}"/>
                         </apex:outputText>
                    </apex:column>
                    <apex:column headerValue="{!$Label.Pol_Member_Status}">{!m.person.memberStatusDesc}</apex:column>
                    <apex:column headerValue="{!$Label.Pol_Benefit_Type}">{!m.person.GroupMedicalBenefitStr}</apex:column>
                    <apex:column headerValue="{!$Label.Pol_Life_Sum_Assured}">
                        <apex:outputText value="{!IF(m.person.lifeSumAssuredInNumber == null ,'',policy.currencySymbol)} {0, Number,###,##0.00}" escape="false">
                             <apex:param value="{!m.person.lifeSumAssuredInNumber}"/>
                        </apex:outputText>
                    </apex:column>
                    <apex:column headerValue="{!$Label.Pol_TPD_Sum_Assured}">
                        <apex:outputText value="{!IF(m.person.TPDSumAssuredInNumber == null ,'',policy.currencySymbol)} {0, Number,###,##0.00}" escape="false">
                             <apex:param value="{!m.person.TPDSumAssuredInNumber}"/>
                        </apex:outputText>
                    </apex:column>
                    <apex:column headerValue="{!$Label.Pol_AD_D_Sum_Assured} ">
                        <apex:outputText value="{!IF(m.person.addSumAssuredInNumber == null ,'',policy.currencySymbol)} {0, Number,###,##0.00}" escape="false">
                             <apex:param value="{!m.person.addSumAssuredInNumber}"/>
                         </apex:outputText>
                    </apex:column>
                    <apex:column headerValue="{!$Label.Pol_LTD_Sum_Assured} ">
                        <apex:outputText value="{!IF(m.person.LTDSumAssuredInNumber == null ,'',policy.currencySymbol)} {0, Number,###,##0.00}" escape="false">
                             <apex:param value="{!m.person.LTDSumAssuredInNumber}"/>
                        </apex:outputText>
                    </apex:column>
                    <apex:column headerValue="{!$Label.Pol_CIB_Sum_Assured}">
                        <apex:outputText value="{!IF(m.person.CIBSumAssuredInNumber == null ,'',policy.currencySymbol)} {0, Number,###,##0.00}" escape="false">
                             <apex:param value="{!m.person.CIBSumAssuredInNumber}"/>
                        </apex:outputText>
                    </apex:column>
                    <apex:column headerValue="" style="cursor:pointer;text-align:center;" onclick="retriveIndividualPolicy('{!m.person.policyNumber}','{!m.person.ssnNumber}','{!m.person.fullName}');changeSection(this);">
                        <i aria-hidden="true" class="ci-hk-arrow-28"></i>                                                                        
                    </apex:column> 
                    <apex:facet name="footer">
                        <div style="text-align:right;{!IF(memberWrapperList.size=0, 'display:none;', '')}">
                            <span> Page {!currentPage} of {!totalPage} &nbsp;</span>                            
                            <span><a href="javascript:void(0);" onclick="MemberListSearch.previous()">&lt;&lt; Previous Page </a></span>    
                            <span> &nbsp; | &nbsp;</span>                        
                            <span><a href="javascript:void(0);" onclick="MemberListSearch.next()">Next Page &gt;&gt;</a></span>
                        </div>
                    </apex:facet>
                </apex:pageBlockTable>
                <script type="text/javascript">
                    $(document).ready(function() {
                        
                        if($('input[id$="selectSingleCheckbox"]').length > 0 && $("input[id$='selectSingleCheckbox']").not("input:checked").length == 0){
                            $('input[id$="selectAllCheckbox"]').prop("checked", true);
                        } else {
                            $('input[id$="selectAllCheckbox"]').prop("checked", false);
                        }
                        
                        //CR-56_Link_20220214
                        $('input[id$="selectAllCheckbox"]').on("click",function() {
                            $('input[id$="selectSingleCheckbox"]').prop("checked", this.checked);
                            if($('input[id$="selectSingleCheckbox"]').length > 0 && this.checked){
                                $('#generateOppBtnDiv').show();
                            } else {
                                $('#generateOppBtnDiv').hide();
                            }
                        });
                        
                        $('input[id$="selectSingleCheckbox"]').on("click",function(){
                            if(!this.checked){
                                $('input[id$="selectAllCheckbox"]').prop("checked", false);
                            } else {
                                $('#generateOppBtnDiv').show();
                            }
                            if($("input[id$='selectSingleCheckbox']:checked").length == 0){
                                $('#generateOppBtnDiv').hide();
                            }
                            if($("input[id$='selectSingleCheckbox']").not("input:checked").length == 0){
                                $('input[id$="selectAllCheckbox"]').prop("checked", true);
                            }
                        });
                        
                    });
                </script>
            </apex:pageblockSection>
            <br/>
            <div id="generateOppBtnDiv" style="width:98%;margin:0 auto;text-align: center;display:block;display:none;">
                <apex:outputPanel id="buttonPanel" >
                    <apex:commandButton value="Generate Opportunities" action="{!generateOpportunities}" status="loader-icon" reRender="batchGenOppPageBlock"/>
                </apex:outputPanel>
            </div>
            <br/>   
            <div style="width:98%;margin:0 auto;">
                <apex:outputPanel id="individualPolicyInfoPanel" style="{!IF(showInP,'','display:none')}">                               
                     <apex:pageBlockSection columns="1" title="{!selectedMemberFullName}'s individual policy(ies):"  >            
                         <apex:pageBlockTable value="{!selectedMember.policyList}" var="p" first="{!pStartIndex}" rows="{!pageSize}">
                             <apex:column headerValue="{!$Label.Pol_Product_Name} ">{!p.marketingName}</apex:column>
                             <apex:column headerValue="{!$Label.Person_Insured} ">{!p.insuredNameStr}</apex:column>
                             <apex:column headerValue="{!$Label.Pol_Effective_Date}">
                                <apex:outputText value="{0, date, yyyy/MM/dd}"><apex:param value="{!p.effDateInDate}"/></apex:outputText>
                             </apex:column>
                             <apex:column headerValue="{!$Label.Pol_Policy_Number}">{!p.policyNumber}</apex:column>
                             <apex:column headerValue="{!$Label.Pol_Status}">{!p.policyStatus}</apex:column>
                             <apex:facet name="footer">
                                 <div style="text-align:right;{!IF(selectedMember.policyList.size=0, 'display:none;', '')}">
                                     <span> Page {!pCurrentPage} of {!pTotalPage} &nbsp;</span>                            
                                     <span><a href="javascript:void(0);" onclick="IndividualPolicyInfoSearch.pPrevious()">&lt;&lt; Previous Page </a></span>    
                                     <span> &nbsp; | &nbsp;</span>                        
                                     <span><a href="javascript:void(0);" onclick="IndividualPolicyInfoSearch.pNext()">Next Page &gt;&gt;</a></span>
                                 </div>
                             </apex:facet>
                         </apex:pageBlockTable>
                     </apex:pageBlockSection>
                 </apex:outputPanel>
            </div>
        </apex:pageBlock>
        <script> twistSection(document.getElementById('{!$Component.batchGenOppPageBlock.individualPolicyInfoPanel}').getElementsByTagName('img')[0]) </script>
    </apex:form>                       

    <script type="text/javascript">
        var selectedNumber = 0;
        function retriveIndividualPolicy(memberPolicyNo, memberSSN, memberFullName){
            getIndividualPolicyList(memberPolicyNo,memberSSN,memberFullName);
            scrollToEnd();
            var icons = document.getElementsByTagName('i');
            for(var i=0;i<icons.length;i++){
                icons[i].setAttribute("class","ci-hk-arrow-28");
            }
        }
        
        function changeSection(section){
            var icon = $(section).find('i');
            if(icon.hasClass("ci-hk-arrow-28")){
                console.log($(section));
                icon.removeClass("ci-hk-arrow-28").addClass("ci-hk-arrow-29");
            }else if(icon.hasClass("ci-hk-arrow-29")){
                icon.removeClass("ci-hk-arrow-29").addClass("ci-hk-arrow-28");
            }
        }
           
        function scrollToEnd(){
            var h = $(document).height()-$(window).height();
            $(document).scrollTop(h);
        }
        
        $(document).ready(function() {
            MemberListSearch.getMemberList();
        });
    </script>
                
</apex:page>
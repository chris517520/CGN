<apex:page Controller="TestFileUploadController" showHeader="false" sidebar="false" docType="html-5.0" cache="false">
        <!-- Bootstrap Core CSS -->
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/jquery.min.js')}"></script>
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/bootstrap.min.js')}"></script>
    
       
        <script type="text/javascript">
            var __sfdcSessionId = '{!GETSESSIONID()}';
            var filesToUpload = '';  
            var uploadedFile = 0;
        </script>
        
        <script src="/soap/ajax/37.0/connection.js" type="text/javascript"></script>

     <script>

        function showLoading() {
            $('#loading').fadeIn(100);
        }
        
        function finishSubmission() {
            $('#loading').fadeOut(100);
            $('#complete').fadeIn(100);
        }

        //Add by Manuel to define a global variable to indicate the files amount and number
        var filesAmt; 
        var fileNum;
    
        /** upload files**/
        /*For upload attachment*/  
        function uploadFile(parentId)
        {
            
            showLoading();
            
            //Add by Manuel on 20180927 to support multiple files select and upload function start
            var arrFiles = new Array();
        
            $("#fileUpload").each(function(){
                //filesToUpload=$(this)[0].files[0]; // Comment by Manuel on 20180927 that legacy single file select upload every time
                filesAmt = $(this)[0].files.length; //Add by Manuel to define a global variable to indicate the files amount and number 
                for(var j=0; j<$(this)[0].files.length; j++){
                    arrFiles[j] = $(this)[0].files[j];
                }
            });
            fileNum = 0; //Add by Manuel to define a global variable to indicate the files amount and number
            for(var k=0; k<arrFiles.length; k++){
                filesToUpload = arrFiles[k];
                //Add by Manuel on 20180927 to support multiple files select and upload function stop
    
                var reader = new FileReader();
        
                // Keep a reference to the File in the FileReader so it can be accessed in callbacks
                reader.file = filesToUpload;
                
                if(typeof(filesToUpload)  === "undefined"){
                    alert('please select file.');
                    
                }else{
                    reader.onload = function(e)
                    {
                        var maxFileSize = 26214400;
                        var passFileSize;
                        var passFileType;
                        
                        if(this.file.size>maxFileSize){
                            $("#errFileSize").show();
                            passFileType = false;
                            finishSubmission();
                        }else{
                            passFileSize = 'true';
                            $("#errFileSize").hide();
                        }
                        if(this.file.type!='application/vnd.openxmlformats-officedocument.wordprocessingml.document' && this.file.type!='application/msword' && this.file.type!='application/pdf' && this.file.type!='image/png' && this.file.type!='image/jpeg' && this.file.type!='image/tiff'){
                            $("#errFileType").show();
                            finishSubmission();
                        }else{
                            passFileType  = 'true';
                            $("#errFileType").hide();
                        }
                        
                        console.log("herer");
                        
                        if(passFileType=='true' && passFileSize=='true' && parentId && parentId!=undefined){
                            
                            var binary = "";
                            var bytes = new Uint8Array(e.target.result);
                            var length = bytes.byteLength;

                            
                            for (var i = 0; i < length; i++)
                            {
                                binary += String.fromCharCode(bytes[i]);
                            }
                            
                            

                            var attachment_object = {
                                parentId: parentId,
                                Body: window.btoa(binary), 
                                Name: this.file.name, 
                                ContentType: this.file.type 
                            };

                            $.ajax({
                                url: '{!$Site.BaseUrl}/services/data/v38.0/sobjects/Attachment',
                                data: JSON.stringify(attachment_object),
                                type: 'POST',
                                processData: false,
                                contentType: false,
                                headers: {'Authorization': 'Bearer {!GETSESSIONID()}', 'Content-Type': 'application/json'},
                                xhr: function(){
                                    var xhr = new window.XMLHttpRequest();
                                    //Upload progress
                                    xhr.upload.addEventListener("progress", function(evt){
                                        if (evt.lengthComputable) {
                                            var percentComplete = evt.loaded / evt.total;
                                            //Do something with upload progress
                                            console.log("Percentage:"+percentComplete);
                                        }
                                    }, false);
                                    return xhr;
                                },
                                success: function(response) {
                                    console.log(response); 
                                    fileNum++; //Add by Manuel to define a global variable to indicate the files amount and number
                                    checkFilesAmtNum(fileNum);
                                },

                                error: function(xhr, status, error) {
                                    var errorMessage = xhr.status + ': ' + xhr.statusText
                                    console.log('ERROR:'+ errorMessage); 
                                    fileNum++; //Add by Manuel to define a global variable to indicate the files amount and number
                                    checkFilesAmtNum(fileNum);
                                }
                            });
                            
                        }else{
                        
                            //finishSubmission(); //Add by Manuel to update spinner status
                        }
                    };
                    
                    reader.readAsArrayBuffer(filesToUpload);
                }
            }//Add by Manuel on 20180927 
        } 
                
        //Add by Manuel to define a global variable to indicate the files amount and number
        function checkFilesAmtNum(fileNumber){
            if(fileNumber==filesAmt){
                finishSubmission();
            }
        }
        
               
        
    </script>

    <apex:form >
         <apex:actionFunction action="{!generateObject}" 
                        name="generateObject" 
                        reRender="{!IF(productCode=='@CBOG','dummyvalue','')}">
        </apex:actionFunction>

        <apex:outputPanel id="parentIdPanel">
            <div onclick="generateObject();">Generate Object</div>
            <div>
                ParentId: {!parentId}
            </div>
            <apex:outputPanel id="fileUploadPanel" rendered="{!ableToUpload}">
            <div>
                <input id="fileUpload" type="file" multiple="multiple" class="fileInput" onchange="uploadFile('{!parentId}');" />upload file
            </div>
            <div id="loading" style="display:none;">
                Loading...
            </div>
            <div id="complete" style="display:none;">
                Done!
            </div>
        </apex:outputPanel>
        </apex:outputPanel>

        

        <div id="errFileSize" role="alert" style="display:none;">
            File_size_exceeds_10M
        </div>
        <div id="errFileType" role="alert" style="display:none;">
            Please_upload_a_valid_file (i.e. .docx/.doc/.pdf/.jpeg/.png/.tiff)
        </div>

    </apex:form>
       <!--
     <script>

        function showLoading() {
            $('#loading').fadeIn(100);
        }
        
        function finishSubmission() {
            $('#loading').fadeOut(100);
            $('#complete').fadeIn(100);
        }
        
     </script>
       
  <apex:sectionHeader title="Visualforce Example" subtitle="Attachment Upload Example"/>
    
  <apex:form enctype="multipart/form-data">
    <apex:pageMessages />
    
    <apex:actionFunction action="{!generateObject}" 
                    name="generateObject" 
                    reRender="parentIdPanel, fileUploadPanel">
    </apex:actionFunction>
    
    <apex:actionFunction action="{!upload}" 
                 name="save">
    </apex:actionFunction>
    
  
    
    <apex:outputPanel id="parentIdPanel">    
        
        <div onclick="generateObject();">Generate Object</div>
        <div>
            ParentId: {!parentId}
        </div>
        
        <apex:outputPanel id="fileUploadPanel" rendered="{!ableToUpload}">        
            <apex:pageBlock title="Upload a Attachment">
                
              <apex:pageBlockButtons >
                <apex:commandButton action="{!upload}" value="Save"/>
              </apex:pageBlockButtons>
             
              <apex:pageBlockSection columns="2">
        
                <apex:pageBlockSectionItem >
                  <apex:outputLabel value="File Name" for="fileName"/>
                  <apex:inputText value="{!attachment.name}" id="fileName"/>
                </apex:pageBlockSectionItem>
        
                <apex:pageBlockSectionItem >
                  <apex:outputLabel value="File" for="file"/>
                  <apex:inputFile value="{!attachment.body}" filename="{!attachment.name}" id="file"/>
                </apex:pageBlockSectionItem>
        
              </apex:pageBlockSection>
        
            </apex:pageBlock>
            <div onclick="showLoading();save();">Upload</div>
            <div id="loading" style="display:none;">
                Loading...
            </div>
            <div id="complete" style="display:none;">
                Done!
            </div>
         </apex:outputPanel>
         
    </apex:outputPanel>
    
    
  </apex:form>
   -->
</apex:page>
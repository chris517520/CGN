<apex:page showHeader="false">

    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width"/>
        <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DD_Demo, 'css/bootstrap_ns.css')}" />
        <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DD_Demo, 'css/font-awesome.min.css')}" />
        <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DD_Demo, 'owl.carousel/owl.carousel.css')}" />
        <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DD_Demo, 'owl.carousel/owl.theme.css')}" />
        <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.DD_Demo, 'owl.carousel/owl.transitions.css')}" />
        <apex:stylesheet value="{!URLFOR($Resource.Cigna_HK_Icons, 'Cigna-HK-Icons.css')}"/>
        <apex:include pageName="CignaCommonCSS" />
        
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/jquery.min.js')}"></script>
        <!--<script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/bootstrap.min.js')}"></script>-->
         <!-- HKITSFDC-26 -->
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'js/bootstrap3.3.6.min.js')}"/>
        <script type="text/javascript" src="{!URLFOR($Resource.DD_Demo, 'owl.carousel/owl.carousel.min.js')}"></script>
        <apex:include pageName="CignaUtilJS" />
        <style>
            body {
                margin: auto;
                background: #f9f9f9;
            }
            
            @font-face {
                font-family: MontserratLight;
                src: url("{!URLFOR($Resource.DD_Demo, 'fonts/Montserrat-Light.otf')}") format("opentype");
            }
            
            .bs {
                font-family: "MontserratLight", Arial, Helvetica, sans-serif;
            }
            
            .bs .navbar-toggle .icon-bar {
                background-color: #188CCC !important;
            }
            
            .bs .navbar-brand {
                padding: 10px !important;
            }
            
            #owl-promotion-mobile .item img {
                display: block;
                width: 100%;
                height: auto;
            }
            
            #owl-promotion-desktop .item img {
                display: block;
                width: 100%;
                height: auto;
            }
            
            @media (min-width: 1px) and (max-width: 768px) {
                .bs .navbar-nav li {
                    background-color: #004986 !important;
                    border-bottom: 1px solid #fff !important;
                }
                .bs .navbar-nav li > a {
                    color: #fff !important;
                }
            }
            
            .bs .navbar-nav li:hover {
                background-color: #39B54A !important;
            }
            
            .bs .navbar-nav li a:hover {
                color: #fff !important;
            }
            
            .bs div.section {
                position: absolute !important;
                left: 0 !important;
                width: 100% !important;
                background: #188CCC !important;
                padding-left: 5%;
            }
            
            .bs div.section > h4 {
                color: #FFF;
            }
            
            #record-list {
                font-size: 14px;
            }
            
            .fa-check-circle {
                color: #39B54A;
            }
            
            .fa-times-circle {
                color: #e80000;
            }
            
            .bs .btn-default {
                /* color: #fff !important;
                    background-color: #2E2E2E !important;
                    border-color: #2E2E2E !important;*/
                color: #fff !important;
                background-color: #2E2E2E !important;
                border-color: #2E2E2E !important;
                font-color: #fff !important;
            }
            
            #liveAgentClientChat.liveAgentStateWaiting {
                // The CSS class that is applied when the chat request is waiting to be accepted
                // See "Waiting State" screenshot below
            }
            
            #liveAgentClientChat {
                // The CSS class that is applied when the chat is currently engaged
                // See "Engaged State" screenshot below
            }
            
            #liveAgentClientChat.liveAgentStateEnded {
                // The CSS class that is applied when the chat has ended
                // See "Ended State" screenshot below
            }
            
            body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0
            }
            
            #waitingMessage {
                height: 100%;
                width: 100%;
                vertical-align: middle;
                text-align: center;
                display: none;
            }
            
            #liveAgentClientChat.liveAgentStateWaiting #waitingMessage {
                display: table;
            }
            
            .liveAgentSaveButton {
                z-index: 2;
                color: #fff !important;
                background: #39B54A !important;
                border-color: #39B54A !important;
            }
            
            .liveAgentEndButton {
                z-index: 2;
                color: #fff !important;
                background: #39B54A !important;
                border-color: #39B54A !important;
            }
            
            #fileCancelButton {
                z-index: 2;
                color: #fff !important;
                background: #39B54A !important;
                border-color: #39B54A !important;
            }
            
            #liveAgentSaveButton,
            #liveAgentEndButton {
                z-index: 2;
            }
            
            .liveAgentChatInput {
                height: 25px;
                border-width: 1px;
                border-style: solid;
                /*border-color: #000;*/
                padding: 2px 0 2px 0px;
                background: #fff;
                display: block;
                width: 99.9%;
                background: #fff !important;
                font-size: 14px;
                border-color: #bfbfbf!important;
            }
            
            .liveAgentSendButton {
                display: block;
                width:60px;
                position: absolute;
                top: 0;
                right: -67px;
                margin-top:5px !important;
                color: #fff !important;
                background: #39B54A !important;
                border-color: #39B54A !important;
            }
            
            #liveAgentChatLog {
                width: auto;
                height: auto;
                top: 0px;
                position: absolute;
                overflow-y: auto;
                left: 0;
                right: 0;
                bottom: 0;
                background: #fff !important;
                font-size: 14px;
                border-color: #bfbfbf!important;
            }
            
            .bs .btn-primary {
                color: #fff !important;
                background-color: #2E2E2E !important;
                border-color: #2E2E2E !important;
                font-color: #fff !important;
            }
            
            .header-bar {
                background-color: #D9D9D6;
                color: #FFF;
                background-image: url({!$Resource.LiveChat_Banner_New});
                background-size:100%;
                font-size: 1.25em;
                text-align: center;
                height:150px;
                position: relative;
             }
            
        </style>
        
        <!-- Rancho_HKITSFDC212_20250401 - remove hard-code url -->
        <!--
        <script>
            function closeWin() {
                window.close();
            }
            var thename = document.getElementById("liveAgentClientChatSettings");
            var myVar = setTimeout(function() {
                if (thename.className == "no_chat no_brand") {
                    var sitePrefix = "{!IF(ISBLANK($Site.Prefix), '', $Site.Prefix)}";
                    var pageName = '/{!$Label.LiveChatMessageToCasePageName}';
                    if (sitePrefix != "") {
                        pageName = sitePrefix + pageName;
                    }
                    if ((typeof sforce != 'undefined') && sforce && (!!sforce.one)) {
                        // Salesforce1 navigation
                        sforce.one.navigateToURL(pageName);
                    } else {
                        // Set the window's URL using a Visualforce expression
                        // alert(pageName);
                        window.location.href = pageName;
                    }
    
                }
                if (thename != null && thename.className == "no_brand") {
                    // alert("In chat");
                }
            }, 120000);
            
            if (thename != null && ththename.className == "no_brand") {
                $(window).bind('beforeunload', function() {
                    stopCobrowse();
                    return 'The Cobrowse End';
                });
            }
            
        </script>
        -->

        <script type="text/javascript">
            
            $(function(){
                if(Cigna.Util.isIOS() || Cigna.Util.isAndroid()){
                    $('.liveAgentCobrowseButton').css('display', 'none');
                }
                
                /*$("#ReminderDialog modal-dialog").css({ 
                    position:'absolute', 
                    left:($(window).width() - $("#ReminderDialog").outerWidth())/2, 
                    top:($(window).height() - $("#ReminderDialog").outerHeight())/2 + $(document).scrollTop() 
                });*/
                /*$('#ReminderDialog').on('show.bs.modal', function (e) {
                    var $modal_dialog = $('#ReminderDialog');
                    var m_top = ( $(document).height() - $modal_dialog.height() )/2;
                    $modal_dialog.css({'margin': m_top + 'px auto'});
                });*/
                
                if(Cigna.Util.checkWebView()){
                    $('#closeBtn').show();
                    $('#save').hide();
                }else{
                    $('#save-app').hide();
                }
                
            });
            
            var waitingTimeout = setTimeout(function(){
                                    $('#ReminderDialog').modal('show');
                                }, 120000);
        
            function waitForMoreMinutes(minutes){
                waitingTimeout = setTimeout(function(){
                    $('#ReminderDialog').modal('show');
                }, minutes*60*1000);
            }
            
            function timeoutRedirect(){
                window.location.href = "{!$Setup.Portal_Settings__c.Customer_Portal_URL__c}/apex/{!$Label.LiveChatMessageToCasePageName}";
                
                //Cigna.Util.navigateToVFP('{!$Label.LiveChatMessageToCasePageName}', null, null, false, false);
                /*var livechatWindow = document.getElementById("liveAgentClientChatSettings");
                if (livechatWindow.className == "no_chat no_brand") {
                    
                    var pageName = '/{!$Label.LiveChatMessageToCasePageName}';
                                        
                    if ((typeof sforce != 'undefined') && sforce && (!!sforce.one)) {
                        var sitePrefix = "{!IF(ISBLANK($Site.Prefix), '', $Site.Prefix)}";
                        if (sitePrefix != "") {
                            pageName = sitePrefix + pageName;
                        }
                        sforce.one.navigateToURL(pageName); // Salesforce1 navigation
                    } else {
                        window.location.href = "{!$Setup.Portal_Settings__c.Customer_Portal_URL__c}/apex" + pageName;
                    }
    
                }*/
                //if (thename.className == "no_brand") {
                    // alert("In chat");
                //}
            }
            
        //  var waitingTimeout = setTimeout(function() {
        //        $('#ReminderDialog').modal({backdrop: 'static'});
        //    }, 120000);
            
            var thename = document.getElementById("liveAgentClientChatSettings");
            
            if (thename != null && thename.className == "no_brand") {
                $(window).bind('beforeunload', function() {
                    cancelChatByVisitor();
                    stopCobrowse();
                    return 'The Cobrowse End';
                });
            }
            
            function convertDate(inputDate, inputTime){
                
                var year = inputDate.getFullYear();
                var month = (inputDate.getMonth() + 1);
                var day = inputDate.getDate();
                
                var timeList = inputTime.split(":");
                
                var hour = parseInt(timeList[0]);
                var min = parseInt(timeList[1]);
                var sec = parseInt(timeList[2].substring(0, 2));
                
                var period = inputTime.slice(-2);
                
                if(period == "PM" && hour < 12){
                    hour += 12;
                }else if(period == "AM" && hour == 12){
                    hour = 0;
                }
                
                return new Date(year, (month-1), day, hour, min, sec);
            }
            
            function appSaveChat(){
                
                var roleList = [];
                var messageList = [];
                var timestampList = [];
                
                var currentTimestamp = new Date();
                var prevTimestamp = new Date();
                var newTimestamp = new Date();
                var content = "";
                
                $('#liveAgentChatLogText').children().each(function () {
                    console.log('live chat log: ',$(this));
                    if($(this).find('.name').text() != ""){
                        roleList.push($(this).find('.name').text());
                        messageList.push($(this).find('.messageText').text());
                    }
                    
                    if($(this).hasClass('timestamp')){
                        timestampList.push($(this).text());   
                    }
                    
                });
                
                for(var i = 0; i < roleList.length; i++){
                    
                    if(i > 0){
                        prevTimestamp = convertDate(currentTimestamp, timestampList[i-1]);
                    }
                    
                    newTimestamp = convertDate(currentTimestamp, timestampList[i]);
                    
                    if(i > 0 && newTimestamp < prevTimestamp){
                        currentTimestamp.setDate(currentTimestamp.getDate() + 1);
                        
                        newTimestamp = convertDate(currentTimestamp, timestampList[i]);
                    }
                    
                    content += roleList[i] + "(" + newTimestamp + ") " + messageList[i] + "<br/>";
                }
                
                var inputUrl = "https://{!$Site.Domain}/filedownload/LiveChatTranscript?content="+ encodeURIComponent(content);
                
                location.href=inputUrl;
            }
            
        </script>
    </head>
    
    <body class="bs" id="body">
        <div class="bs header-bar" style="margin-top: 0px; background-position-y: 30%;">
            <p style="position: relative; top: 45%; text-align:center;text-transform: uppercase;">
                {!$Label.LiveChat_Banner_Title}
            </p>
            <div id="closeBtn" style="display:none;position: relative; top: 0; text-align:right;margin-right: 5px;">
                <a style="font-size: 12px;color:white;" onclick="cancelChatByVisitor();Cigna.Util.navigateToVFP('CustomerLoginVFP', null, null, false, false);">X {!$Label.Close}</a>
            </div>
            <div style="display:none;position: relative; top: 0; text-align:right;margin-right: 5px;">
                <a id="timeoutBtn" href="{!$Setup.Portal_Settings__c.Customer_Portal_URL__c}/apex/{!$Label.LiveChatMessageToCasePageName}" style="font-size: 12px;color:white;" onclick="cancelChatByVisitor();">For Iphone Ipad Timeout</a>
            </div>
        </div>
        <div class="bs container-fluid " style="top: 155px; left: 0; right: 0; bottom: 10px; position: absolute;">
            <liveAgent:clientChat >
                <input type="hidden" name="liveagent.prechat.findorcreate.map:Product2" value="Name,Canna Health" />
                <input type="hidden" name="liveagent.prechat.findorcreate.map:Contact" value="FirstName,contactFirstName;" />
                <input type="hidden" name="liveagent.prechat.findorcreate.showOnCreate:Contact" value="true" />
                <input type="hidden" name="liveagent.prechat.findorcreate.showOnCreate:Account" value="name,Chan Ha hA;show,true" />
                <div class="bs" style="float:left;"> <!-- onclick="closeWin()" -->
                    <liveAgent:clientChatEndButton id="ChatEndButtonId" label="{!$Label.LiveChat_End_Chat}"/>
                </div>
                <!-- remove the T&C in co-browsing as confirmed by requirement.
                <div class="bs" style="float:left;margin-left:5px;">
                    <button class="bs liveAgentChatElement liveAgentEndButton liveAgentCobrowseButton" type="button" data-backdrop="static" data-toggle="modal" data-target="#TermsDialog">{!$Label.StartCobrowse}</button>
                </div>
                -->
                <!-- PPCP-36 temporary disable the Co-browse button in the Live Chat pop-up-->
                <div class="bs" style="float:left;margin-left:5px;">
                    <button class="bs liveAgentChatElement liveAgentEndButton liveAgentCobrowseButton" type="button" onclick="startCobrowse();">{!$Label.StartCobrowse}</button>
                </div>
                
                <!--<div class="bs" style="float:right;">
                    <liveAgent:clientChatSaveButton label="{!$Label.LiveChat_Save}"/>
                </div>-->
                <div id="save" class="bs liveAgentChatElement" style="padding-right:0px !important;">
                   <a class="bs cigna-fg-orange-medium pull-right onclick-pointer" onclick="SfdcApp.LiveAgent.Chasitor.saveChat();" style="text-decoration: none;">
                      {!$Label.LiveChat_Save} <i class="ci-hk-briefcase" aria-hidden="true" style="font-weight:bold;"></i> 
                   </a>
                </div>
                <div id="save-app" class="bs liveAgentChatElement" style="padding-right:0px !important;">
                   <a class="bs cigna-fg-orange-medium pull-right onclick-pointer" onclick="appSaveChat();" style="text-decoration: none;">
                      {!$Label.LiveChat_Save} <i class="ci-hk-briefcase" aria-hidden="true" style="font-weight:bold;"></i> 
                   </a>
                </div>
                
                <div class="bs container-fluid " style="top: 25px; left: 5px; right: 5px; bottom: 5px; position: absolute; z-index:0;color: '#0000FF'">
                    <liveAgent:clientChatFileTransfer fileTransferUploadLabel="Send a file over" />
                </div>
                <div class="bs container" style="top: 40px; left: 5px; right: 5px; bottom: 5px; position: absolute; z-index:0;">
                    <liveAgent:clientChatAlertMessage />
                    <liveAgent:clientChatStatusMessage />
                    <table id="waitingMessage" cellpadding="0" cellspacing="0">
                        <tbody id="waitingMessage1">
                            <tr>
                                <td style="font-size: 15px">
                                    <label>{!$Label.Please_wait_to_be_connected_with_an_available_representative}</label>
                                    <div id="queuePositionMessage" style="font-weight:bold"> </div>
                                </td>
                            </tr>
                        </tbody>
                        <div style="display:none" id="chatQueuePosition"> <liveAgent:clientChatQueuePosition /></div>
                    </table>
                    <div style="top: 0; right: 0; bottom: 55px; left: 0; padding: 0; position: absolute;word-wrap: break-word; z-index: 0;">
                        <liveAgent:clientChatLog id="clientChatLog" showTimeStamp="true"/>
                    </div>
                    <div class="bs container-fluid " style="position: absolute; height: auto; right: 0; bottom: 0; left: 0; margin-right:67px; padding:5px 0 5px 0">
                        <liveagent:clientChatInput />
                        <liveAgent:clientChatSendButton label="{!$Label.LiveChat_Send}"/>
                    </div>
                </div>
            </liveAgent:clientChat>
            <!-- Terms Dialog -->
            <div id="TermsDialog" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <!-- Modal content-->
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">{!$Label.Initiating_CoBrowsing}</h4>
                        </div>
                        <div class="modal-body" style="height:300px;overflow:auto;">
                            <p> 1.Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam at porttitor sem. Aliquam erat volutpat. Donec placerat nisl magna, et faucibus arcu condimentum sed. 1.Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam at porttitor sem. Aliquam erat volutpat. Donec placerat nisl magna, et faucibus arcu condimentum sed 1.Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam at porttitor sem. Aliquam erat volutpat. Donec placerat nisl magna, et faucibus arcu condimentum sed 1.Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam at porttitor sem. Aliquam erat volutpat. Donec placerat nisl magna, et faucibus arcu condimentum sed</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick=" $('#TermsDialog').modal('hide');startCobrowse()" type="button">{!$Label.Cobrowse_Initiating_Accept}</button>
                            <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="stopCobrowse()">{!$Label.Cobrowse_Initiating_Decline}</button>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        <div id="ReminderDialog" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <!--<button type="button" class="close" data-dismiss="modal">&times;</button>-->
                        <h4 class="modal-title">{!$Label.LiveChatMessageToCase_Waiting_Reminder_Title}</h4>
                    </div>
                    <div class="modal-body" style="height:60px;">
                        <p>{!$Label.LiveChatMessageToCase_Waiting_Reminder}</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick=" $('#ReminderDialog').modal('hide');waitForMoreMinutes(2);" type="button">{!$Label.OK}</button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="cancelChatByVisitor();timeoutRedirect();" >{!$Label.Cancel}</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="WaitingReminderDialog" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <!--<button type="button" class="close" data-dismiss="modal">&times;</button>-->
                        <h4 class="modal-title">{!$Label.LiveChatMessageToCase_Waiting_Reminder_Title}</h4>
                    </div>
                    <div class="modal-body" style="height:60px;">
                        <span id="queuePositionDialogMessage"> </span>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick=" $('#WaitingReminderDialog').modal('hide');" type="button">{!$Label.OK}</button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal" onclick='cancelChatByVisitor();timeoutRedirect();'>{!$Label.Cancel}</button>
                    </div>
                </div>
            </div>
        </div>
       
        <script type='text/javascript' src='{!$Setup.Portal_Settings__c.Live_Agent_JavaScript_URL__c}'></script>
        <script type='text/javascript'>
            // liveagent.enableLogging();  
            //liveagent.addCustomDetail('MyName', 'Visitor', true);
            // liveagent.findOrCreate('Product2').map('name', 'MyName', true, true, false).showOnCreate();
            //liveagent.findOrCreate("Account").map("Name", "MyName", true, true, false).saveToTranscript('accountId').showOnCreate();
            //liveagent.findOrCreate("Case").map("name", "MyName", true, true, true).saveToTranscript("CaseId").showOnCreate();
            
            //liveagent.addCustomDetail('Franco Test', 'Franco Zheng !!!', true);
            //liveagent.addCustomDetail('Name', '{!$User.LastName} {!$User.FirstName}', true);
            //liveagent.findOrCreate("Account").map("name", "Name", true, true, true).saveToTranscript('accountId').showOnCreate();
            
            //liveagent.init('{!$Setup.Portal_Settings__c.Live_Agent_Init_URL__c}', '{!$Setup.Portal_Settings__c.Live_Agent_Deployment_ID__c}', '{!$Organization.Id}'.substring(0,15)); 
            //chat idle timeout warning
            liveagent.addEventListener(liveagent.chasitor.Events.START_CHASITOR_IDLE_TIMEOUT_WARNING,
                function(){
                    var ampm = formatAMPM(new Date());
                    var message = '<span class="system" style="margin-bottom:10px;"><em><apex:outputText value="{!$Label.LiveChat_Start_Timeout_Warning}" escape="false"></apex:outputText></em><span class="timestamp">' + ampm + '</span></span>';
                    $("#liveAgentChatLogText").append(message);
                }
            );
            
            liveagent.addEventListener(liveagent.chasitor.Events.CHAT_ESTABLISHED,
                function(){
                    //alert('franco test CHAT_ESTABLISHED');
                }
            );
            
            liveagent.addEventListener(liveagent.chasitor.Events.CHAT_REQUEST_SUCCESSFUL,
                function(){
                    //alert('franco test CHAT_REQUEST_SUCCESSFUL');
                    //$('#ReminderDialog').modal({backdrop: 'static'});
                }
            );
            
			liveagent.addEventListener(liveagent.chasitor.Events.CHAT_REQUEST_FAILED,
                function(){
                     timeoutRedirect();
                }
            );
            
            
        </script>
        <a id="Cobrowse_startSession" href="javascript:;" glance_button="startSession" style="display: none"></a>
        <a id="Cobrowse_stopSession" href="javascript:;" glance_button="stopSession" style="display: none"></a>
        <a id="Cobrowse_showTerms" href="javascript:;" glance_button="showTerms" style="display: none"></a>
        <script id="cobrowsescript" type="text/javascript" src="https://www.glancecdn.net/cobrowse/CobrowseJS.ashx?group={!$Setup.Portal_Settings__c.Glance_Cobrowse_Group_ID__c}&site={!$Setup.Portal_Settings__c.Glance_Cobrowse_Site__c}" data-inputevents='{"shift-13":"startSession"}' data-groupid="{!$Setup.Portal_Settings__c.Glance_Cobrowse_Group_ID__c}" data-site="{!$Setup.Portal_Settings__c.Glance_Cobrowse_Site__c}" charset="UTF-8"  data-termsurl="http://cigna.com.hk/zh-hant/legal#1"></script>
        <script type="text/javascript">
            function startCobrowse() {
                var evt = document.createEvent("MouseEvents");
                evt.initMouseEvent("click", true, true, window,
                    0, 0, 0, 0, 0, false, false, false, false, 0, null);
                var a = document.getElementById("Cobrowse_startSession");
                a.dispatchEvent(evt);
            }
            
            function stopCobrowse() {
                var evt = document.createEvent("MouseEvents");
                evt.initMouseEvent("click", true, true, window,
                    0, 0, 0, 0, 0, false, false, false, false, 0, null);
                var a = document.getElementById("Cobrowse_stopSession");
                a.dispatchEvent(evt);
            }
            
            function closeWin() {
                window.close();
            }
            
            function cancelChatByVisitor(){
                liveagent.chasitor.cancelChat();
            }
            
            function formatAMPM(date) {
                var hours = date.getHours();
                var minutes = date.getMinutes();
                var seconds = date.getSeconds();
                var ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                minutes = minutes < 10 ? '0'+minutes : minutes;
                seconds = seconds < 10 ? '0'+seconds : seconds;
                var strTime = hours + ':' + minutes + ':' + seconds + ' ' + ampm;
                return strTime;
            }
            
            setInterval(function(){
                var displayCSS = $('.liveAgentChatElement.liveAgentEndButton').css("display");
                if(displayCSS === 'inline-block'){ //mean the agent has accepted the request
                    clearTimeout(waitingTimeout);
                }
            },500);
            
           /* Modal.prototype.adjustDialog = function () {
                var modalIsOverflowing = this.$element[0].scrollHeight > document.documentElement.clientHeight
                this.$element.css({
                    paddingLeft:  !this.bodyIsOverflowing && modalIsOverflowing ? this.scrollbarWidth : '',
                    paddingRight: this.bodyIsOverflowing && !modalIsOverflowing ? this.scrollbarWidth : ''
                });
                var $modal_dialog = $(this.$element[0]).find('#ReminderDialog');
                var m_top = ( $(document).height() - $modal_dialog.height() )/2;
                $modal_dialog.css({'margin': m_top + 'px auto'});
            }*/
        </script>
        <script type="text/javascript">
            liveagent.chasitor.addCustomEventListener('startCobrowse', function customEventReceived(receiveResult) {
                if (receiveResult.getType() == 'startCobrowse') {
                    if (confirm('Start Cobrowse?')) {
                        var data = receiveResult.getData().split('|');
                        var message = {
                            glance_invoke: {
                                func: 'startSession',
                                args: {
                                    sessionKey: data[1]
                                },
                                groupid: data[2]
                            }
                        };
                        //alert(data[0] + ' ' + data[1]);
                        // Send message to the page that started the chat to start the cobrowse.
                        window.opener.top.postMessage(message, '*');
                        // Send event back to agent that cobrowse has been started.
                        liveagent.chasitor.sendCustomEvent('cobrowseStarted', '');
                    }
                }
            });
        </script>
        <!--
        <script type="text/javascript">
            var detailCallback = function (details){
                console.log('go into detailCallback '); 
                for (var i = 0; i < details.customDetails.length; i++) {
                    if(details.customDetails[i].label == 'PreferProduct'){
                        console.log(details.customDetails[i].value);
                    }
                }
            }; 
        </script>
        -->
        <script>
  			
        	function QueueFunction(){
                var queueSize = {!$Setup.LiveChatQueueSize__c.queueSize__c};
                var queuePosition = parseInt(liveagent.chasitor.getQueuePosition());
                if(queuePosition > queueSize){
                    cancelChatByVisitor();timeoutRedirect();
                }else if(queuePosition <= queueSize && queuePosition > 0){
                    updateQueuePosition();
                    $('#queuePositionDialogMessage').append("{!$Label.LiveChatMessageToCase_Waiting_Message} "+queuePosition);
                    $('#WaitingReminderDialog').modal('show');
                }
            }
        
        	function updateQueuePosition(){ 
                var queuePosition = parseInt(liveagent.chasitor.getQueuePosition());
                var queuePositionMessage = "{!$Label.LiveChatMessageToCase_Waiting_Message}";
                $("#queuePositionMessage").html(queuePositionMessage+" "+queuePosition);
                $('#chatQueuePosition').unbind();
                $('#chatQueuePosition').on('DOMSubtreeModified', function() {
                    updateQueuePosition();
                });
            }
        
        	$( document ).ready(function() {
                var chatQueueInit = false;
                $('#chatQueuePosition').on('DOMSubtreeModified', function() {
					if(!chatQueueInit){
                        chatQueueInit = true;
                        var waitingforAutoQueue = setTimeout(function(){
                              QueueFunction();
                         }, 2000);
                     }
        		});
            });
        </script>
    </body>
</apex:page>